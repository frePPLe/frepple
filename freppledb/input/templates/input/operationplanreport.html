{% extends "admin/base_site_grid.html" %}
{% load i18n %}
{% load static %}

{% block extrastyle %}{{block.super}}
<style>
#attributes-supplyinformation thead tr td,
#attributes-networkstatus thead tr td,
#attributes-downstreamoperationplans thead tr td,
#attributes-upstreamoperationplans thead tr td,
#attributes-operationproblems thead tr td,
#attributes-operationresources thead tr td,
#attributes-operationflowplans thead tr td,
#attributes-operationdemandpegging thead tr td,
#attributes-inventorydata thead tr td {
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: #bbb;
}

rect.opplan {
  vector-effect: non-scaling-stroke;
  stroke-width: 1px;
  stroke: rgb(0,0,0);
}

/* Button group icons */
.btn-primary.active:disabled {
  background-color: var(--bs-btn-active-bg);
}
</style>
{% endblock %}

{% block extrahead %}{{block.super}}
<script src="{{STATIC_URL}}js/d3.min.js"></script>

{% if debug_js %}
<script type="module" src="http://localhost:5173/static/src/main.js"></script>
<script type="module" src="http://localhost:5173/static/@vite/client"></script>
{% else %}
<script src="{{STATIC_URL}}input/main.js"></script>
{% endif %}
<script>

  var urlParams = new URLSearchParams(window.location.search);
  var mode = preferences && preferences.mode || "table";
  var calendarmode = preferences && preferences.calendarmode || "{{reportclass.calendarmode}}";
  var grouping = preferences && preferences.grouping || null;
  var groupingdir = preferences && preferences.groupingdir || "asc";
  var editable = {% if reportclass.editable and haschangeperm %}true{% else %}false{% endif %};
  var service_url = {% if proxied %}'/svc/{{request.database}}/'{% else %}document.location.protocol + "//{{port}}/"{% endif %};
  var service_token = '{{token}}';
  var isDataSaved = false;
  // the following variables are set in Vue components
  var operationplanChanges = {};
  var pageIDs = [];

  function getVisibleSelectedIds() {
    pageIDs = window.jQuery("#grid").jqGrid && window.jQuery("#grid").jqGrid('getDataIDs') || [];
    const vueSelectedOperationPlans = upload.selectedRows.map((op) => op.reference || op);

    // filter out selected IDs that do not belong to this page
    upload.selectedRows = pageIDs.filter((id) => vueSelectedOperationPlans.includes(id));

    return upload.selectedRows
  }

  function saveData(rows, ok_callback) {
      $.ajax({
        url: service_url + 'operationplan/',
        data: JSON.stringify(rows),
        type: "POST",
        headers: { "Authorization": "Bearer " + service_token },
        contentType: "application/json",
        success: function () {
          upload.undo();
          jQuery("#save i").addClass('hidden');
          jQuery(".ng-dirty").removeClass('ng-dirty');
          if (typeof ok_callback !== 'undefined') ok_callback();
          isDataSaved = true;
        },
        error: ajaxerror
    });
    operationplanChanges = {};
    isDataSaved = true; // for test
  }

  function extraPreference() {
    var tmp = {
      "height": Math.floor(jQuery("#content-main").height()),
      "width": Math.floor(jQuery("#fields").width()),
      "mode": mode,
      "calendarmode": calendarmode,
      "columns": window.appInstance?.kanbancolumns || window.preferences.columns || undefined,
      "grouping": grouping,
      "groupingdir": groupingdir,
      "detailwidth": Math.floor(jQuery("#detailspanel").width() || 0),
      "widgets": jQuery(".widget").length > 1 ? widget.getConfig() : preferences.widgets
    };
    return tmp;
  }

  function extraSearchUpdate(filter) {
    thefilter = filter;
  	if (preferences && preferences.mode == "kanban") {
      initialfilter = filter;
  	  angular.element('#controller').scope().loadKanbanData(filter);
  	  return true;
  	}
  	else if (preferences && preferences.mode == "gantt") {
      initialfilter = filter;
  	  angular.element('#controller').scope().loadGanttData(filter);
  	  return true;
  	}
    else if (preferences && preferences.mode && preferences.mode.startsWith("calendar")) {
      initialfilter = filter;
      angular.element('#controller').scope().loadCalendarData(filter);
      return true;
    }
    return false;
  }

  function setHeights() {
    var h = jQuery('#content-main').height();
    jQuery('#grid').setGridWidth(jQuery('#content-main').width());
    jQuery("#grid").setGridHeight(h - 52);
    jQuery(".column-body").css("height", h - 25);
    jQuery("#scrolldayview").css("height", h - 25);
    jQuery("#scrollweekview").css("height", h - 60);
    jQuery("#scrollmonthview").css("height", h - 45);
  }

  function setWidths() {
    var w = jQuery("#workarea").width() - jQuery('#detailspanel').width() - jQuery("#resize-handle").parent().width();
    jQuery('#grid').setGridWidth(w);
    jQuery("#grid").setGridHeight(jQuery('#content-main').height() - 52);
    jQuery("#kanban").css("width", w - 25);
    jQuery("#scrolldayview").css("width", w - 25);
    jQuery("#scrollweekview").css("width", w - 60);
    jQuery("#scrollmonthview").css("width", w - 45);
  }

  function getDirtyData() {
  	if (preferences && preferences.mode && (preferences.mode == "kanban" || preferences.mode == "gantt" || preferences.mode.startsWith("calendar"))) {
      initialfilter = thefilter;
      return angular.element('#controller').scope().getDirtyCards();
    }
  	else {
      var dirty = jQuery("#grid").getChangedCells('dirty');
      for (var c of dirty) {
        var ref = jQuery("#grid").jqGrid('getCell', c.id, "operationplan__reference");
        if (ref) c.operationplan__reference = ref;
      }
      savedData = false;
      return dirty;
    }
  }

  var language = "{{LANGUAGE_CODE}}";
  var version = '{% version_short %}';
  var lastid = '';
  var preferences = {{ preferences | json }};
  var default_operationplan_type = "{{ default_operationplan_type }}";
  var groupBy = "{{ groupBy }}";
  var thefilter = initialfilter;
  var groupingcfg = {{ groupingcfg | json }};
  var currentdate = new Date("{{ currentdate|date:'Y-m-d' }}");

  var horizonstart = new Date({{request.report_startdate|date:"Y"}},{{request.report_startdate|date:"n"}}-1,{{request.report_startdate|date:"j"}});
  var horizonend = new Date({{request.report_enddate|date:"Y"}},{{request.report_enddate|date:"n"}}-1,{{request.report_enddate|date:"j"}});
  var viewstart = new Date(horizonstart.getTime());
  var viewend = new Date(horizonend.getTime());


  jQuery(function() {
    jQuery("#workarea").css('overflow-x','visible');
    jQuery("#content-main").resizable({
      handleSelector: "#resize-handle",
      resizeWidth: false,
      resizeHeight: true,
      onDrag: setHeights,
      onDragEnd: function (e, $el, opt) {
        grid.saveColumnConfiguration();
      }
    });
    jQuery("#save").on('click', function() {
      jQuery(window).off('beforeunload', upload.warnUnsavedChanges);
      });
    jQuery("#undo").on('click', function() {
      jQuery(window).off('beforeunload', upload.warnUnsavedChanges);
      operationplanChanges = {};
      const event = new CustomEvent('singleSelect', {
      detail: {
          execute: 'undo',
          reference: null,
          status: null,
          selectedRows: null
        }
      });
      document.getElementById('app').dispatchEvent(event);
    });
    jQuery("#actionsul li, button#actions1").on('click', function() {
      const event = new CustomEvent("refreshStatus", {
        detail: {
          execute: 'refreshStatus',
          reference: null,
          status: jQuery("#actions").val(),
          selectedRows: null,
        }
      });
      document.getElementById('app').dispatchEvent(event);
    });
    jQuery("#kanbanmode").on('click', function() {
      mode = "kanban";
      grid.saveColumnConfiguration(function() {
        location.reload();
      });
    });
    jQuery("#calendarmonth").on('click', function() {
      mode = "calendarmonth";
      grid.saveColumnConfiguration(function() {
        location.reload();
      });
    });
    jQuery("#calendarweek").on('click', function() {
      mode = "calendarweek";
      grid.saveColumnConfiguration(function() {
        location.reload();
      });
    });
    jQuery("#calendarday").on('click', function() {
      mode = "calendarday";
      grid.saveColumnConfiguration(function() {
        location.reload();
      });
    });
    jQuery('#zoomin').on("click", function() { zoom(0.5); });
    jQuery('#zoomout').on("click", function() { zoom(2); });
    {% if showGantt %}
    jQuery("#ganttmode").on('click', function() {
      mode = "gantt";
      grid.saveColumnConfiguration(function() {
        location.reload();
      });
    });
    jQuery("#zoomin, #zoomout").removeClass("d-none");
    {% endif %}
  });

  // // Controller will call this function to pass values to the grid
  function displayongrid(id, columnid, value) {
    jQuery("#"+id).removeClass("edited").addClass("edited");
    if (
      columnid === "startdate" ||
      columnid === "enddate" ||
      columnid === "quantity" ||
      columnid === "quantity_completed" ||
      columnid === "remark" ||
      (columnid === "status" && ['proposed', 'approved', 'confirmed', 'completed', 'closed'].indexOf(value) > -1)
    ) {
      jQuery("#grid").jqGrid("setCell", id, columnid, value, "dirty-cell");
      jQuery("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled", false);
      jQuery(window).off('beforeunload', upload.warnUnsavedChanges);
      jQuery(window).on('beforeunload', upload.warnUnsavedChanges);
    }
  }

  window.displayongrid = displayongrid;

  jQuery("#workarea").css('overflow-x', 'visible');
  jQuery("#resize-handle").css({ 'display': 'inline-block' });

  jQuery("#content-main").resizable({
    handleSelector: "#resize-handle",
    resizeWidth: false,
    resizeHeight: true,
    onDrag: function (e, $el, opt) {
      jQuery("#grid").setGridHeight(jQuery("#content-main").height() - 52);
    },
    onDragEnd: function (e, $el, opt) {
      // Save column configuration (assuming grid has a save method)
      if (typeof grid !== 'undefined' && typeof grid.saveColumnConfiguration === 'function') {
        grid.saveColumnConfiguration();
      }
    }
  });

  // Set jqGrid single select behavior
  jQuery("#grid").jqGrid("setGridParam", { singleSelectClickMode: "selectonly" });

  // Hide message button
  jQuery("#hidemessage").on("click", function () {
    hidemessage = true;
    jQuery("#hidemessage").parent().parent().hide();
    if (typeof grid !== 'undefined' && typeof grid.saveColumnConfiguration === 'function') {
      grid.saveColumnConfiguration();
    }
  });

  // Dispatch event when grid refreshes
  document.addEventListener('DOMContentLoaded', function () {
    window.addEventListener('gridRefresh', function (event) {
      if (typeof refreshGrid === 'function') {
        refreshGrid();
      }
    });
  });

</script>
{% endblock %}

{% block extracontainer %}{% endblock %}

{% block tools %}{% if args %}{% include "common/snippet_follow.html" %}{% endif %}{% endblock %}

{% block tabs %}{% if args %}{% tabs model %}{% endif %}{% endblock %}

{% block actions %}
  <div class="btn-group" role="group">
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display table"|capfirst|force_escape %}"
      class="btn btn-sm btn-primary{% if preferences.mode != 'kanban' and preferences.mode != 'gantt' and preferences.mode != 'calendarday' and preferences.mode != 'calendarweek' and preferences.mode != 'calendarmonth' or not preferences.mode %} active{% endif %}"
      type="button" id="gridmode" name="mode">
      <span class="fa fa-table fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display kanban cards"|capfirst|force_escape %}" class="btn btn-sm btn-primary{% if preferences.mode == 'kanban' %} active{% endif %}" type="button" id="kanbanmode" name="mode">
      <span class="fa fa-columns fa-lg fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    <div class="btn-group dropdown" data-bs-toggle="tooltip" data-bs-toggle="tooltip"
      data-bs-placement="top" title="{% trans "display calendar"|capfirst|force_escape %}">
      <button type="button" id="calendarmode" name="mode"
        class="btn btn-sm btn-primary dropdown-toggle{% if preferences.mode == 'calendarday' or preferences.mode == 'calendarweek' or preferences.mode == 'calendarmonth' %} active{% endif %}"
        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="fa fa-calendar-o"></span>
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li class="dropdown-item" id="calendarmonth"><a href="#">{% trans "month"|capfirst %}</a></li>
        <li class="dropdown-item" id="calendarweek"><a href="#">{% trans "week"|capfirst %}</a></li>
        <li class="dropdown-item" id="calendarday"><a href="#">{% trans "day"|capfirst %}</a></li>
      </ul>
    </div>
    {% if showGantt %}
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display Gantt chart"|capfirst|force_escape %}" class="btn btn-sm btn-primary{% if preferences.mode == 'gantt' %} active{% endif %}" type="button" id="ganttmode" name="mode">
      <span class="fa fa-align-left fa-lg fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    {% endif %}
  </div>
{% if hasaddperm %}<button class="btn btn-sm btn-primary" onclick="location.href='{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/add/{% if is_popup %}?_popup=1{% endif %}'" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans "Create new object"|escape %}" ><span class="fa fa-plus"></span></button>
{% endif %}{% if hasaddperm and not is_popup and reportclass.canDuplicate %}<button class="btn btn-sm btn-primary"  disabled id="copy_selected" onclick="grid.showCopy()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Copy selected objects'|capfirst|escape %}" ><span class="fa fa-copy"></span></button>
{% endif %}
<!--{% if haschangeperm and not is_popup %}<button class="btn btn-sm btn-primary" id="edit_selected" disabled onclick="grid.update('{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/')" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans "Update objects"|escape %}" ><span class="fa fa-edit"></span></button>
{% endif %}-->
{% if hasdeleteperm and not is_popup %}<button class="btn btn-sm btn-primary" id="delete_selected" disabled data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Delete selected objects'|capfirst|escape %}" onclick="grid.showDelete('{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/')" ><span class="fa fa-minus"></span></button>
{% endif %}{% if reportclass.hasTimeBuckets %}<button class="btn btn-sm btn-primary" onclick="grid.showBucket()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'set time horizon'|capfirst|force_escape %}" id="bucketconfig"><span class="fa fa-clock-o"></span></button>
{% endif %}<button class="btn d-none btn-sm btn-primary" id="zoomin" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Zoom in'|capfirst|force_escape %}"><span class="fa fa-search-plus"></span></button>
<button class="btn d-none btn-sm btn-primary" id="zoomout" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Zoom out'|capfirst|force_escape %}"><span class="fa fa-search-minus"></span></button>
{% if hasaddperm %}<button class="btn btn-sm d-none d-md-inline-block btn-primary" id="csvimport" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Import CSV or Excel file'|capfirst|force_escape %}" onclick="import_show('', undefined, true)"><span class="fa fa-arrow-up"></span></button>
{% endif %}<button class="btn btn-sm btn-primary" onclick="grid.showExport(true,{{ scenario_permissions }})" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'export as CSV or Excel file'|capfirst|force_escape %}"><span class="fa fa-arrow-down"></span></button>
<button id="customize" class="btn btn-sm btn-primary" onclick="grid.showCustomize(false);" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'customize'|capfirst|force_escape %}"><span class="fa fa-wrench"></span></button>
{% endblock %}

{% block afterPageLoad %}
displayGrid({% if preferences.mode != "kanban" and preferences.mode != "gantt" and preferences.mode != "calendarday" and preferences.mode != "calendarweek" and preferences.mode != "calendarmonth" %}true{% else %}false{% endif %});
{% endblock %}

{% block extra_grid %}

onSelectRow: function(rowid, status) {
  const rowData = jQuery("#grid").getRowData(rowid);
  const reference = rowData.operationplan__reference ? rowData.operationplan__reference : rowid;

  const references = jQuery("#grid").jqGrid('getGridParam', 'selarrrow').filter(x => x.id !== 'cb').map(x => x.operationplan__reference ? x.operationplan__reference : x);
  const event = new CustomEvent("singleSelect", {
    detail: {
      execute: 'displayInfo',
      reference: reference,
      status: status,
      selectedRows: references,
    }
  });
  document.getElementById('app').dispatchEvent(event);

  var sel = jQuery("#grid").jqGrid('getGridParam', 'selarrrow') || [];
  upload.selectedRows = sel.filter(x => x.id !== 'cb');

  var visibleIds = (jQuery("#grid").jqGrid && jQuery("#grid").jqGrid('getDataIDs')) || [];
  var selectedIds = sel.map(function(x){ return (x && typeof x === 'object') ? (x.id || x.operationplan__reference || String(x)) : String(x); });
  var hasVisible = selectedIds.filter(function(id){ return id !== 'cb' && visibleIds.indexOf(id) !== -1; }).length > 0;
  ['#actions1','#actions2','#segments1','#copy_selected','#delete_selected'].forEach(function(s){ var el=jQuery(s); if (el.length) el.prop('disabled', !hasVisible); });
},
onSelectAll: function(aRowids, status){
  const event = new CustomEvent('allSelect', {
    detail: {
      execute: 'displayInfo',
      status: status,
      selectedRows: aRowids,
    }
  });
  document.getElementById('app').dispatchEvent(event);
  if (jQuery("#actions").length) jQuery("#actions1").prop('disabled', !status);
  var sel = jQuery("#grid").jqGrid('getGridParam', 'selarrrow') || [];
  upload.selectedRows = sel.filter(x => x.id !== 'cb');
  if (sel.length !== 0 && status)  {
    var visibleIds = (jQuery("#grid").jqGrid && jQuery("#grid").jqGrid('getDataIDs')) || [];
    var selectedIds = sel.map(function(x){ return (x && typeof x === 'object') ? (x.id || x.operationplan__reference || String(x)) : String(x); });
    var hasVisible = selectedIds.filter(function(id){ return id !== 'cb' && visibleIds.indexOf(id) !== -1; }).length > 0;
    ['#actions1','#actions2','#segments1','#copy_selected','#delete_selected'].forEach(function(s){ var el=jQuery(s); if (el.length) el.prop('disabled', !hasVisible); });
  }
},

afterSaveCell: function(rowid, cellname, value, iRow, iCol) {
  const rowData = jQuery("#grid").getRowData(rowid);
  const reference = rowData.operationplan__reference ? rowData.operationplan__reference : rowid;

  const event = new CustomEvent('displayonpanel', {
    detail: {
      rowid: rowid,
      reference: reference,
      field: cellname,
      value: value
    }
  });
  document.getElementById('app').dispatchEvent(event);
  isDataSaved = false;
},

multiboxonly: false,
loadComplete: function(data) {
  const pageSelectedIDs = getVisibleSelectedIds();
  const changedOperationplanReferences = Object.keys(operationplanChanges);
  if (Object.keys(changedOperationplanReferences) > 0) {
    changedOperationplanReferences.forEach((reference) => {
      console.log("435 loadComplete", changedOperationplanReferences.reference);
      if (pageSelectedIDs.includes(reference)) {
        const changedCellsKeys = Object.keys(operationplanChanges[id]);
        changedCellsKeys.forEach((field) => {
          try {
            displayongrid(id, field, operationplanChanges[id][field]);
          } catch (e) {
            // ignore
          }
        });
      }
    });
  }
  const IDs = Object.keys(operationplanChanges);

  jQuery('#curerror').html("");
  getVisibleSelectedIds().forEach(function(op) {
    jQuery("#grid").jqGrid('setSelection', op, false);
  })

  const references = jQuery("#grid").jqGrid('getGridParam', 'selarrrow').filter(x => x.id !== 'cb').map(x => x.operationplan__reference ? x.operationplan__reference : x);

  if (getVisibleSelectedIds().length === 1) {
    let event = new CustomEvent('displayonpanel', jQuery("#grid").getRowData(getVisibleSelectedIds()[0]));
    document.getElementById('app').dispatchEvent(event);

    event = new CustomEvent("singleSelect", {
      detail: {
        execute: 'displayInfo',
        reference: getVisibleSelectedIds()[0],
        status: status,
        selectedRows: references,
      }
    });
    document.getElementById('app').dispatchEvent(event);
  } else if (getVisibleSelectedIds().length > 1) {
    var selectiondata = [];
    for (var x of getVisibleSelectedIds())
      selectiondata.push(jQuery("#grid").getRowData(x));

    event = new CustomEvent('processAggregatedInfo', {
      detail: {
        selectiondata: selectiondata,
        colModel: jQuery("#grid").jqGrid ('getGridParam', 'colModel')
      }
    });
    document.getElementById('app').dispatchEvent(event);
  } else {
    const event = new CustomEvent('allSelect', {
      detail: {
        execute: 'displayInfo',
        status: false,
        selectedRows: [],
      }
    });
    document.getElementById('app').dispatchEvent(event);
  }
  // Initialize actions buttons state based on visible-page selection after load
  var sel = jQuery("#grid").jqGrid('getGridParam', 'selarrrow') || [];
  var visibleIds = (jQuery("#grid").jqGrid && jQuery("#grid").jqGrid('getDataIDs')) || [];
  var selectedIds = sel.map(function(x){ return (x && typeof x === 'object') ? (x.id || x.operationplan__reference || String(x)) : String(x); });
  var hasVisible = selectedIds.filter(function(id){ return id !== 'cb' && visibleIds.indexOf(id) !== -1; }).length > 0;
  ['#actions1','#actions2','#segments1','#copy_selected','#delete_selected'].forEach(function(s){ var el=jQuery(s); if (el.length) el.prop('disabled', !hasVisible); });
},
{% endblock %}

{% block table %}
<div>

<div class="row text-center">
<div id="content-main" class="col-md-12" style="min-height: 150px; margin-top: 0.7em">
  <div :hidden="mode == 'kanban' || mode == 'gantt' || mode.startsWith('calendar')">
    <table id="grid" class="table table-striped" style="background-color: white"></table>
    <div id="gridpager"></div>
  </div>
  <div id="calendar" :hidden="!mode.startsWith('calendar')" class="col-md-12">
  </div>
  <div id="kanban" :hidden="mode != 'kanban'" class="row"></div>
  <div id="gantt" :hidden="mode != 'gantt'" class="row"></div>
</div>
<span id="resize-handle" class="fa fa-bars handle" style="display: inline-block"></span>
</div>

<svg width="0" height="0"><defs id="gradients"></defs></svg>
{% endblock %}

{% block after_table %}
<div id="app"></div>
<div id="popup" class="modal fade in" role="dialog" style="z-index: 10000"></div>
{% endblock %}
