{% extends "admin/base_site_grid.html" %}
{% load i18n %}
{% load static %}

{% block extrastyle %}{{block.super}}
<style>
#attributes-supplyinformation thead tr td,
#attributes-networkstatus thead tr td,
#attributes-downstreamoperationplans thead tr td,
#attributes-upstreamoperationplans thead tr td,
#attributes-operationproblems thead tr td,
#attributes-operationresources thead tr td,
#attributes-operationflowplans thead tr td,
#attributes-operationdemandpegging thead tr td,
#attributes-inventorydata thead tr td {
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: #bbb;
}

rect.opplan {
  vector-effect: non-scaling-stroke;
  stroke-width: 1px;
  stroke: rgb(0,0,0);
}

/* Button group icons */
.btn-primary.active:disabled {
  background-color: var(--bs-btn-active-bg);
}
</style>
{% endblock %}

{% block extrahead %}{{block.super}}
<script src="{{STATIC_URL}}js/d3.min.js"></script>
<script src="{{STATIC_URL}}js/angular.min.js"></script>

{% if debug_js %}
<script type="module" src="http://localhost:5173/static/src/main.js"></script>
<script type="module" src="http://localhost:5173/static/@vite/client"></script>
{% endif %}
<script>

  var urlParams = new URLSearchParams(window.location.search);
  var mode = preferences && preferences.mode || "table";
  var calendarmode = preferences && preferences.calendarmode || "{{reportclass.calendarmode}}";
  var grouping = preferences && preferences.grouping || null;
  var groupingdir = preferences && preferences.groupingdir || "asc";
  var editable = {% if reportclass.editable and haschangeperm %}true{% else %}false{% endif %};
  var service_url = {% if proxied %}'/svc/{{request.database}}/'{% else %}document.location.protocol + "//{{port}}/"{% endif %};
  var service_token = '{{token}}';
  var showChildren = (!urlParams.has("noautofilter") && preferences && "showChildren" in preferences) ? preferences.showChildren : true;
  var showTop = (!urlParams.has("noautofilter") && preferences && "showTop" in preferences) ? preferences.showTop : true;

  function saveData(rows, ok_callback) {
      $.ajax({
        url: service_url + 'operationplan/',
        data: JSON.stringify(rows),
        type: "POST",
        headers: { "Authorization": "Bearer " + service_token },
        contentType: "application/json",
        success: function () {
          upload.undo();
          $("#save i").addClass('hidden');
          $(".pg-dirty").removeClass('pg-dirty');   //TODO change class name
          if (typeof ok_callback !== 'undefined') ok_callback();
        },
        error: ajaxerror
    });
  }

  function extraPreference() {
    var tmp = {
      "height": Math.floor($("#content-main").height()),
      "width": Math.floor($("#fields").width()),
      "mode": mode,
      "calendarmode": calendarmode,
      "columns": window.appInstance?.kanbancolumns || [],
      "grouping": grouping,
      "groupingdir": groupingdir,
      "detailwidth": Math.floor($("#detailspanel").width() || 0),
      "widgets": widget.getConfig()
    };
    if (!urlParams.has("noautofilter")){
      tmp["showTop"] = showTop;
      tmp["showChildren"] = showChildren;
    }
    return tmp;
  }

  function extraSearchUpdate(filter) {
    thefilter = filter;
  	if (preferences && preferences.mode == "kanban") {
      initialfilter = filter;
  	  angular.element('#controller').scope().loadKanbanData(filter);
  	  return true;
  	}
  	else if (preferences && preferences.mode == "gantt") {
      initialfilter = filter;
  	  angular.element('#controller').scope().loadGanttData(filter);
  	  return true;
  	}
    else if (preferences && preferences.mode && preferences.mode.startsWith("calendar")) {
      initialfilter = filter;
      angular.element('#controller').scope().loadCalendarData(filter);
      return true;
    }
    return false;
  }

  function setHeights() {
    var h = $('#content-main').height();
    $('#grid').setGridWidth($('#content-main').width());
    $("#grid").setGridHeight(h - 52);
    $(".column-body").css("height", h - 25);
    $("#scrolldayview").css("height", h - 25);
    $("#scrollweekview").css("height", h - 60);
    $("#scrollmonthview").css("height", h - 45);
  }

  function setWidths() {
    var w = $("#workarea").width() - $('#detailspanel').width() - $("#resize-handle").parent().width();
    $('#grid').setGridWidth(w);
    $("#grid").setGridHeight($('#content-main').height() - 52);
    $("#kanban").css("width", w - 25);
    $("#scrolldayview").css("width", w - 25);
    $("#scrollweekview").css("width", w - 60);
    $("#scrollmonthview").css("width", w - 45);
  }

  function getDirtyData() {
  	if (preferences && preferences.mode && (preferences.mode == "kanban" || preferences.mode == "gantt" || preferences.mode.startsWith("calendar"))) {
      initialfilter = thefilter;
      return angular.element('#controller').scope().getDirtyCards();
    }
  	else {
      var dirty = $("#grid").getChangedCells('dirty');
      for (var c of dirty) {
        var ref = $("#grid").jqGrid('getCell', c.id, "operationplan__reference");
        if (ref) c.operationplan__reference = ref;
      }
      return dirty;
    }
  }

  var language = "{{LANGUAGE_CODE}}";
  var version = '{% version_short %}';
  var lastid = '';
  var preferences = {{ preferences | json }};
  var default_operationplan_type = "{{ default_operationplan_type }}";
  var groupBy = "{{ groupBy }}";
  var thefilter = initialfilter;
  var groupingcfg = {{ groupingcfg | json }};
  var currentdate = new Date("{{ currentdate|date:'Y-m-d' }}");

  var horizonstart = new Date({{request.report_startdate|date:"Y"}},{{request.report_startdate|date:"n"}}-1,{{request.report_startdate|date:"j"}});
  var horizonend = new Date({{request.report_enddate|date:"Y"}},{{request.report_enddate|date:"n"}}-1,{{request.report_enddate|date:"j"}});
  var viewstart = new Date(horizonstart.getTime());
  var viewend = new Date(horizonend.getTime());


  $(function() {
    $("#workarea").css('overflow-x','visible');
    $("#content-main").resizable({
      handleSelector: "#resize-handle",
      resizeWidth: false,
      resizeHeight: true,
      onDrag: setHeights,
      onDragEnd: function (e, $el, opt) {
        grid.saveColumnConfiguration();
      }
    });
    $("#save").on('click', function() {
      $(window).off('beforeunload', upload.warnUnsavedChanges);
      });
    $("#undo").on('click', function() {
      $(window).off('beforeunload', upload.warnUnsavedChanges);
      const event = new CustomEvent('singleSelect', {
      detail: {
          execute: 'undo',
          reference: null,
          status: null,
          selectedRows: null
        }
      });
      document.getElementById('app').dispatchEvent(event);
    });

  // // Controller will call this function to pass values to the grid
  function displayongrid(id, columnid, value) {
    console.log( "displayongrid called with id: " + id + ", columnid: " + columnid + ", value: " + value);
    $("#"+id).removeClass("edited").addClass("edited");
    if (
      columnid === "startdate" ||
      columnid === "enddate" ||
      columnid === "quantity" ||
      columnid === "quantity_completed" ||
      columnid === "remark" ||
      (columnid === "status" && ['proposed', 'approved', 'confirmed', 'completed', 'closed'].indexOf(value) > -1)
    ) {
      $("#grid").jqGrid("setCell", id, columnid, value, "dirty-cell");
      $("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled", false);
      $(window).off('beforeunload', upload.warnUnsavedChanges);
      $(window).on('beforeunload', upload.warnUnsavedChanges);
    }
  }

  window.displayongrid = displayongrid;

  jQuery("#workarea").css('overflow-x', 'visible');
  jQuery("#resize-handle").css({ 'display': 'inline-block' });

  jQuery("#content-main").resizable({
    handleSelector: "#resize-handle",
    resizeWidth: false,
    resizeHeight: true,
    onDrag: function (e, $el, opt) {
      jQuery("#grid").setGridHeight(jQuery("#content-main").height() - 52);
    },
    onDragEnd: function (e, $el, opt) {
      // Save column configuration (assuming grid has a save method)
      if (typeof grid !== 'undefined' && typeof grid.saveColumnConfiguration === 'function') {
        grid.saveColumnConfiguration();
      }
    }
  });

  // Set jqGrid single select behavior
  jQuery("#grid").jqGrid("setGridParam", { singleSelectClickMode: "selectonly" });

  // Hide message button
  jQuery("#hidemessage").on("click", function () {
    hidemessage = true;
    jQuery("#hidemessage").parent().parent().hide();
    if (typeof grid !== 'undefined' && typeof grid.saveColumnConfiguration === 'function') {
      grid.saveColumnConfiguration();
    }
  });
  });

  // Dispatch event when grid refreshes
  document.addEventListener('DOMContentLoaded', function () {
    window.addEventListener('gridRefresh', function (event) {
      if (typeof refreshGrid === 'function') {
        refreshGrid();
      }
    });
  });

</script>
{% endblock %}

{% block extracontainer %}{% endblock %}

{% block tools %}{% if args %}{% include "common/snippet_follow.html" %}{% endif %}{% endblock %}

{% block tabs %}{% if args %}{% tabs model %}{% endif %}{% endblock %}

{% block actions %}
  {% if reportkey == "freppledb.input.views.manufacturing.ManufacturingOrderList" %}<div class="btn-group" role="group">
    <button id="showTop" type="button" class="btn btn-sm btn-outline-primary{% if noautofilter or "showTop" not in preferences or preferences.showTop %} active{% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display top level"|capfirst|force_escape %}">
      <svg width="100%" height="1.2em" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
         <rect height="42" width="100" rx="10" ry="10" class="fill-primary"/>
         <rect height="38" x="7" y="55" width="33" rx="10" ry="10" class="stroke-primary" stroke-width="14"/>
         <rect height="38" x="60" y="55" width="33" rx="10" ry="10" class="stroke-primary" stroke-width="14"/>
      </svg>
    </button>
    <button id="showChildren" type="button" class="btn btn-sm btn-outline-primary{% if noautofilter or "showChildren" not in preferences or preferences.showChildren %} active{% endif %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display child level"|capfirst|force_escape %}">
      <svg width="100%" height="1.2em" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
         <rect height="35" x="7" y="7" width="86" rx="10" ry="10" class="stroke-primary" stroke-width="14"/>
         <rect height="45" x="0" y="55" width="45" rx="10" ry="10" class="fill-primary"/>
         <rect height="45" x="55" y="55" width="45" rx="10" ry="10" class="fill-primary"/>
      </svg>
    </button>
  </div>{% endif %}
  <div class="btn-group" role="group">
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display table"|capfirst|force_escape %}"
      class="btn btn-sm btn-primary{% if preferences.mode != 'kanban' and preferences.mode != 'gantt' and preferences.mode != 'calendarday' and preferences.mode != 'calendarweek' and preferences.mode != 'calendarmonth' or not preferences.mode %} active{% endif %}"
      type="button" id="gridmode" name="mode">
      <span class="fa fa-table fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display kanban cards"|capfirst|force_escape %}" class="btn btn-sm btn-primary{% if preferences.mode == 'kanban' %} active{% endif %}" type="button" id="kanbanmode" name="mode">
      <span class="fa fa-columns fa-lg fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    <div class="btn-group dropdown" data-bs-toggle="tooltip" data-bs-toggle="tooltip"
      data-bs-placement="top" title="{% trans "display calendar"|capfirst|force_escape %}">
      <button type="button" id="calendarmode" name="mode"
        class="btn btn-sm btn-primary dropdown-toggle{% if preferences.mode == 'calendarday' or preferences.mode == 'calendarweek' or preferences.mode == 'calendarmonth' %} active{% endif %}"
        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="fa fa-calendar-o"></span>
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li class="dropdown-item" id="calendarmonth"><a href="#">{% trans "month"|capfirst %}</a></li>
        <li class="dropdown-item" id="calendarweek"><a href="#">{% trans "week"|capfirst %}</a></li>
        <li class="dropdown-item" id="calendarday"><a href="#">{% trans "day"|capfirst %}</a></li>
      </ul>
    </div>
    {% if showGantt %}
    <button data-bs-toggle="tooltip" data-bs-placement="top" title="{% trans "display Gantt chart"|capfirst|force_escape %}" class="btn btn-sm btn-primary{% if preferences.mode == 'gantt' %} active{% endif %}" type="button" id="ganttmode" name="mode">
      <span class="fa fa-align-left fa-lg fa-lg" style="margin: 2px 0 3px 0;"></span>
    </button>
    {% endif %}
  </div>
{% if hasaddperm %}<button class="btn btn-sm btn-primary" onclick="location.href='{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/add/{% if is_popup %}?_popup=1{% endif %}'" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans "Create new object"|escape %}" ><span class="fa fa-plus"></span></button>
{% endif %}{% if hasaddperm and not is_popup and reportclass.canDuplicate %}<button class="btn btn-sm btn-primary"  disabled id="copy_selected" onclick="grid.showCopy()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Copy selected objects'|capfirst|escape %}" ><span class="fa fa-copy"></span></button>
{% endif %}
<!--{% if haschangeperm and not is_popup %}<button class="btn btn-sm btn-primary" id="edit_selected" disabled onclick="grid.update('{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/')" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans "Update objects"|escape %}" ><span class="fa fa-edit"></span></button>
{% endif %}-->
{% if hasdeleteperm and not is_popup %}<button class="btn btn-sm btn-primary" id="delete_selected" disabled data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Delete selected objects'|capfirst|escape %}" onclick="grid.showDelete('{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/')" ><span class="fa fa-minus"></span></button>
{% endif %}{% if reportclass.hasTimeBuckets %}<button class="btn btn-sm btn-primary" onclick="grid.showBucket()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'set time horizon'|capfirst|force_escape %}" id="bucketconfig"><span class="fa fa-clock-o"></span></button>
{% endif %}<button class="btn d-none btn-sm btn-primary" id="zoomin" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Zoom in'|capfirst|force_escape %}"><span class="fa fa-search-plus"></span></button>
<button class="btn d-none btn-sm btn-primary" id="zoomout" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Zoom out'|capfirst|force_escape %}"><span class="fa fa-search-minus"></span></button>
{% if hasaddperm %}<button class="btn btn-sm d-none d-md-inline-block btn-primary" id="csvimport" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'Import CSV or Excel file'|capfirst|force_escape %}" onclick="import_show('', undefined, true)"><span class="fa fa-arrow-up"></span></button>
{% endif %}<button class="btn btn-sm btn-primary" onclick="grid.showExport(true,{{ scenario_permissions }})" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'export as CSV or Excel file'|capfirst|force_escape %}"><span class="fa fa-arrow-down"></span></button>
<button id="customize" class="btn btn-sm btn-primary" onclick="grid.showCustomize(false);" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{% trans 'customize'|capfirst|force_escape %}"><span class="fa fa-wrench"></span></button>
{% endblock %}

{% block afterPageLoad %}
displayGrid({% if preferences.mode != "kanban" and preferences.mode != "gantt" and preferences.mode != "calendarday" and preferences.mode != "calendarweek" and preferences.mode != "calendarmonth" %}true{% else %}false{% endif %});
{% endblock %}

{% block extra_grid %}

onSelectRow: function(rowid, status) {
  const rowData = $("#grid").getRowData(rowid);
<!--  console.log('++++operationReport.html onSelectRow ', rowid, status, $("#grid").getRowData(rowid));-->
  const reference = rowData.operationplan__reference || rowid;

  const references = $("#grid").jqGrid('getGridParam', 'selarrrow').filter(x => x.id !== 'cb').map(x => x.operationplan__reference || x.id);
  const event = new CustomEvent("singleSelect", {
    detail: {
      execute: 'displayInfo',
      reference: reference,
      status: status,
      selectedRows: references,
    }

  });
  document.getElementById('app').dispatchEvent(event);
  console.log('operationReport.html singleSelect ', $(this).jqGrid('getGridParam', 'selarrrow'), jQuery("#grid").jqGrid ('getGridParam', 'colModel'));
},
onSelectAll: function(aRowids, status){
  const event = new CustomEvent('allSelect', {
    detail: {
      execute: 'displayInfo',
      status: status,
      selectedRows: aRowids,
    }
  });
  document.getElementById('app').dispatchEvent(event);
  console.log('allSelect', aRowids, status);
},
beforeSaveCell: function(rowid, cellname, value, iRow, iCol) {
  var selection = $(this).jqGrid('getGridParam','selarrrow');
  var selectiondata = [];
  var rowdata = {};
  var temprow = jQuery("#grid").getRowData(rowid);

  jQuery.each(selection , function(index,item){
    if (item === rowid) {
      //update temprow
      temprow[cellname] = value;

      selectiondata.push(temprow);
    } else {
      rowdata = jQuery("#grid").getRowData(item);

      //if is being edited
      var el = $(document.getElementById(item));
      if (typeof el.find("input").attr('cm','[Object Object]').not('.cbox').val() !== 'undefined') {
        if (el.hasClass('success')) {
          if (typeof el.find("input").attr('cm','[Object Object]').not('.cbox').attr("id") !== 'undefined') {
            colname=el.find("input").attr('cm','[Object Object]').not('.cbox').attr("id").split("_")[1];
            if (typeof colname !== 'undefined') {
              rowdata[colname] = el.find("input").attr('cm','[Object Object]').not('.cbox').val();
            }
          }
        }
      }
      selectiondata.push(rowdata);
    }
  });
  upload.select();
  if (selection.length > 1){
    const event = new CustomEvent('processAggregatedInfo', {
    detail: {
      selectiondata: selectiondata,
      colModel: jQuery("#grid").jqGrid ('getGridParam', 'colModel')
      }
    });
    document.getElementById('app').dispatchEvent(event);
  // angular.element('#controller').scope().processAggregatedInfo(selectiondata, jQuery("#grid").jqGrid ('getGridParam', 'colModel'));
  } else {
    const event = new CustomEvent('displayonpanel', {
      detail: {
        rowid: rowid,
        cellname: cellname,
        value: value
      }
    });
    document.getElementById('app').dispatchEvent(event);
    // angular.element('#controller').scope().displayonpanel(rowid, cellname, value);
  }
},
multiboxonly: false,
loadComplete: function(data) {
      $('#curerror').html("");
      if (upload.selectedRows.length === 1) {
        const event = new CustomEvent('displayonpanel', jQuery("#grid").getRowData(upload.selectedRows[0]));
        document.getElementById('app').dispatchEvent(event);
<!--        angular.element('#controller').scope().displayInfo(-->
<!--          jQuery("#grid").getRowData(upload.selectedRows[0])-->
<!--        );-->
      }
      else if (upload.selectedRows.length > 1) {
        var selectiondata = [];
        for (var x of upload.selectedRows)
          selectiondata.push(jQuery("#grid").getRowData(x));

        const event = new CustomEvent('processAggregatedInfo', {
          detail: {
            selectiondata: selectiondata,
            colModel: jQuery("#grid").jqGrid ('getGridParam', 'colModel')
          }
        });
        document.getElementById('app').dispatchEvent(event);
        // angular.element('#controller').scope().processAggregatedInfo(selectiondata, jQuery("#grid").jqGrid ('getGridParam', 'colModel'));
      }
<!--      else {-->
<!--        var s = angular.element('#controller').scope();-->
<!--        if (s) s.processAggregatedInfo([], jQuery("#grid").jqGrid ('getGridParam', 'colModel'));-->
<!--      }-->
<!--      upload.displayonpanel();-->
    },
{% endblock %}

{% block table %}
<div>

<div class="row text-center">
<div id="content-main" class="col-md-12" style="min-height: 150px; margin-top: 0.7em">
  <div data-ng-hide="mode == 'kanban' || mode == 'gantt' || mode.startsWith('calendar')">
    <table id="grid" class="table table-striped" style="background-color: white"></table>
    <div id="gridpager"></div>
  </div>
  <div id="calendar" data-ng-hide="!mode.startsWith('calendar')" class="col-md-12">
    <calendar
      data-range-changed="calendarRangeChanged(startdate, enddate)"
      data-event-selected="displayInfo(event)"
      data-event-source="calendarevents"
      data-editable="{% if reportclass.editable and haschangeperm %}true{% else %}false{% endif %}"
      data-mode="mode"></calendar>
  </div>
  <div id="kanban" data-ng-hide="mode != 'kanban'"
    show-kanban-drv class="row"
    data-editable="{% if reportclass.editable and haschangeperm %}true{% else %}false{% endif %}"
    data-kanbanoperationplans="kanbanoperationplans"
    data-operationplan="operationplan"
    data-kanbancolumns="kanbancolumns">
  </div>
  <div id="gantt" data-ng-hide="mode != 'gantt'"
    show-gantt-drv class="row"
    data-ganttoperationplans="ganttoperationplans"
    data-editable="{% if reportclass.editable and haschangeperm %}true{% else %}false{% endif %}">
  </div>
</div>
<span id="resize-handle" class="fa fa-bars handle" style="display: inline-block"></span>
</div>

<svg width="0" height="0"><defs id="gradients"></defs></svg>
{% endblock %}

{% block after_table %}
<div id="app"></div>
<div id="popup" class="modal fade in" role="dialog" style="z-index: 10000"></div>
{% if not DEBUG_JS %}
<script src="{{STATIC_URL}}input/main.js"></script>
<script src="{{STATIC_URL}}js/frepple-common.min.js"></script>
<script src="{{STATIC_URL}}js/frepple-input.min.js"></script>
<script src="{{STATIC_URL}}js/frepple-operationplandetail.min.js"></script>
{% endif %}
{% endblock %}
