/* frePPLe 4.0.0
Copyright (C) 2010-2019 by frePPLe bv

This library is free software; you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published
by the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
General Public License for more details.

You should have received a copy of the GNU Affero General Public
License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

function webfactory(e,n,t,o,r){"use strict";var a=!1,c=!1,s="",i=angular.element(document);function l(e){angular.element("#controller").scope().databaseerrormodal=!1,s="string"==typeof e?"<p>"+e+"</p>":"object"==typeof e?'<div style="width: 100%; overflow: auto;" class="webservicerror">'+e.description+"</div>":"<p>Websocket connection is not working.</p><p>Please check that <strong>plan.webservice</strong> parameter is set to <strong>true</strong>,<br>and <strong>execute the plan</strong>.</p>",angular.element("#controller").scope().$applyAsync(function(){"object"==typeof e?e.hasOwnProperty("category")&&e.hasOwnProperty("description")&&(i.find(".modal-title span").html("Webservice error"),i.find(".modal-body").css({width:500,height:350,overflow:"auto"}),i.find("#savechangesparagraph").hide(),i.find("#saveAbutton").hide(),i.find(".modal-body").append(s)):(i.find(".modal-title span").html("Websocket connection problem"),i.find(".modal-body").html('<div style="width: 100%; overflow: auto;">'+s+"</div>"))}),angular.element(document).find("#popup2").modal("show")}var u=n(service_url,{reconnectIfNotNormalClose:!0});t(function(){u.send("/alive/")},6e5),u.onMessage(function(n){var t=angular.fromJson(n.data);a&&console.log(t),t.hasOwnProperty("category")&&"error"===t.category?l(t):e.$broadcast("websocket-"+t.category,t)});var d=!1;return u.onError(function(e){d||(d=!0,o({method:"POST",url:url_prefix+"/execute/api/frepple_start_web_service/"}).then(function(e){if("Successfully launched task"!==e.data.message)l();else{const c=e.data.taskid;var n={};const s=url_prefix+"/execute/api/status/?id="+c;var a=t(function(e){o({method:"POST",url:s}).then(function(e){l("Starting Web Service, please wait a moment."),angular.element(document).find("#saveAbutton").hide(),"Web service active"===(n=e.data[Object.keys(e.data)]).message?(t.cancel(a),r.location.reload()):"None"!==n.finished&&"Web service active"!==n.status&&(t.cancel(a),l(),d=!1)})},1e3,0)}},function(e){l(e.data)}))}),{send:function(e){u.readyState>1&&(u=n(service_url),c=!1),c||(u.send("/authenticate/"+service_token),c=!0),a&&console.log("send:"+e),u.send(e)},subscribe:function(n,t){var o=e.$on("websocket-"+n,function(e,n){t(n)});e.$on("$destroy",o)}}}function PreferenceSvc(e){"use strict";return{get:function(e,n){var t=preferences;return e in(t=void 0!==t&&"None"!==t&&null!==t?angular.fromJson(preferences):{})?t[e]:n},save:function(n,t,o){var r=preferences;r=void 0!==r&&"None"!==r&&null!==r?angular.fromJson(preferences):{},"object"==typeof n&&n.length===t.length?angular.forEach(n,function(e,n){r[e]=t[n]}):r[n]=t;var a="/"+angular.element(document).find("#database").attr("name");"/default"!==a&&"/undefined"!==a||(a="");var c={};c[reportkey]=r,e.post(a+"/settings/",angular.toJson(c)).then(function(e){"function"==typeof o&&o(e)},function(e){angular.element(document).find(".modal-body").html('<div style="width: 100%; overflow: auto;">'+e.data+"</div>"),angular.element(document).find("#popup2").modal("show")})}}}angular.module("frepple.common",[]),angular.module("frepple.common").constant("getURLprefix",function(){return"default"===database?"":"/"+database}),angular.module("frepple.common").filter("dateTimeFormat",function(){return function(e,n){return n=n||"YYYY-MM-DD HH:mm:ss",e?e.format(n):""}}),angular.module("frepple.common").factory("WebSvc",webfactory),webfactory.$inject=["$rootScope","$websocket","$interval","$http","$window"],angular.module("frepple.common").service("PreferenceSvc",PreferenceSvc),PreferenceSvc.$inject=["$http"];
//# sourceMappingURL=frepple-common.min.js.map