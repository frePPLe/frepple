/* frePPLe 4.0.0
Copyright (C) 2010-2019 by frePPLe bv

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files(the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/ or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

"use strict";var forecastapp=angular.module("forecastapp",["ngCookies","gettext"],["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]);function customerstable(e){return{transclude:!1,link:function(t,a,s){a.on("click",".evtcustrow",function(e){$(this).css("background-color",""),angular.element(document).find("#customerstable .evtcustrow").removeClass("bg-light"),angular.element(e.target).closest(".evtcustrow").addClass("bg-light");var a=parseInt(angular.element(e.target).closest(".evtcustrow").attr("index"));t.$apply(function(){t.selectCustomer(a)})}),a.on("mouseenter",".evtcustrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","#f5f5f5")}),a.on("mouseleave",".evtcustrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","")}),t.$watchGroup(["customers","customerstrigger"],function(s,r,o){!function(){var s="";if(-1===t.changedcustomerrows[0]&&-1===t.changedcustomerrows[1]){a.children().remove(),s='<div class="d-table w-100"><div style="float: left; overflow:hidden;">&nbsp;</div><div class="ms-auto text-right">';var r=!0;if(t.buckets)for(var o=0;o<t.buckets.length;o++)r?(s+='<span class="numbervalueslast"><strong><small>',r=!1):s+='<span class="numbervalues"><strong><small>',s+=t.buckets[o]+"</small></strong></span>";t.showdescription&&(s+=r?'<span class="numbervalueslast"></span>':'<span class="numbervalues"></span>'),s+="</div></div>";var n=0,i=0,l=0,c=0;angular.forEach(t.customers,function(a,r){if((i=a.lvl)>n?s+='<div level="'+i+'">':i<n&&(s+="</div>"),n=i,!0===a.visible&&!a.hide){s+="<div index="+r+' class="d-flex flex-wrap evtcustrow',a.customer===t.selectedcustomer&&(s+=" bg-light"),s+='"><div style="overflow:hidden; padding-left: '+13*a.lvl+'px;">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');o.text(a.customer),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">';var l=!0;if(a.values){a.values.reverse();for(var c=0;c<a.values.length;c++)l?(s+='<span class="numbervalueslast">',l=!1):s+='<span class="numbervalues">',s+=e("number")(a.values[c].value,0)+"</span>"}if(t.showdescription){var d=l?angular.element('<span class="numbervalueslast"></span>'):angular.element('<span class="numbervalues"></span>');a.description&&d.text(a.description),s+=d[0].outerHTML}s+="</div></div>"}}),a.append(s)}else if(t.changedcustomerrows[0]>=0&&t.changedcustomerrows[1]<0)l=t.changedcustomerrows[0],a[0].querySelector('.evtcustrow[index="'+l+'"]').classList.add("bg-light"),!0===t.customers[l].children&&t.customers[l].expanded<=0&&(a[0].querySelector(".evtcustrow[index='"+l+"'] .fa").classList="fa fa-caret-right"),!0===t.customers[l].children&&t.customers[l].expanded>0&&(a[0].querySelector(".evtcustrow[index='"+l+"'] .fa").classList="fa fa-caret-down"),!0===t.customers[l].children&&t.customers[l].expanded>0?a[0].querySelector('.evtcustrow[index="'+l+'"]').nextSibling.style.display="block":!0===t.customers[l].children&&t.customers[l].expanded<=0&&(a[0].querySelector('.evtcustrow[index="'+l+'"]').nextSibling.style.display="none");else if(t.changedcustomerrows[0]>=0&&t.changedcustomerrows[1]>0){l=t.changedcustomerrows[0];var d=0;c=t.changedcustomerrows[1]-t.changedcustomerrows[0];const r=Array.apply(null,a[0].querySelectorAll(".evtcustrow")).slice(t.changedcustomerrows[0]+1);angular.forEach(r,function(e){d=parseInt(e.getAttribute("index"))+c,e.setAttribute("index",""+d)}),a[0].querySelector(".evtcustrow[index='"+t.changedcustomerrows[0]+"'] .fa").classList="fa fa-caret-down",s='<div level="'+t.customers[t.changedcustomerrows[0]+1].lvl+'">',angular.forEach(t.customers.slice(t.changedcustomerrows[0]+1,t.changedcustomerrows[1]+1),function(a,r){if(l=t.changedcustomerrows[0]+r+1,!0===a.visible&&!a.hide){s+="<div index="+l+' class="d-flex flex-wrap evtcustrow',a.customer===t.selectedcustomer&&(s+=" bg-light"),s+='"><div style="overflow:hidden; text-align: left; padding-left: '+13*a.lvl+'px">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');if(o.text(a.customer),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">',a.values&&(s+='<span class="numbervalueslast">'+e("number")(a.values[2].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[1].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[0].value,0)+"</span>"),t.showdescription){var n=a.values?angular.element('<span class="numbervalues"></span>'):angular.element('<span class="numbervalueslast"></span>');a.description&&n.text(a.description),s+=n[0].outerHTML}s+="</div></div>"}}),s+="</div>",a.find(".evtcustrow[index='"+t.changedcustomerrows[0]+"']").after(s)}}()})}}}function itemstable(e){return{transclude:!1,link:function(t,a,s){a.on("click",".evtitemrow",function(e){$(this).css("background-color",""),angular.element(document).find("#itemstable .evtitemrow").removeClass("bg-light"),angular.element(e.target).closest(".evtitemrow").addClass("bg-light");var a=parseInt(angular.element(e.target).closest(".evtitemrow").attr("index"));t.$apply(function(){t.selectItem(a)})}),a.on("mouseenter",".evtitemrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","#f5f5f5")}),a.on("mouseleave",".evtitemrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","")}),t.$watchGroup(["items","itemstrigger"],function(s,r,o){!function(){var s="";if(-1===t.changeditemrows[0]&&-1===t.changeditemrows[1]){a.children().remove(),s='<div class="d-table w-100"><div style="float: left; overflow:hidden;">&nbsp;</div><div class="ms-auto text-right">';var r=!0;if(t.buckets)for(var o=0;o<t.buckets.length;o++)r?(s+='<span class="numbervalueslast"><strong><small>',r=!1):s+='<span class="numbervalues"><strong><small>',s+=t.buckets[o]+"</small></strong></span>";t.showdescription&&(s+=r?'<span class="numbervalueslast"></span>':'<span class="numbervalues"></span>'),s+="</div></div>";var n=0,i=0,l=0,c=0;angular.forEach(t.items,function(a,r){if((i=a.lvl)>n?s+='<div level="'+i+'">':i<n&&(s+="</div>"),n=i,!0===a.visible&&!a.hide){s+="<div index="+r+' class="d-flex flex-wrap evtitemrow',a.item===t.selecteditem&&(s+=" bg-light"),s+='"><div style="overflow:visible; padding-left: '+13*a.lvl+'px">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');o.text(a.item),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">';var l=!0;if(a.values){a.values.reverse();for(var c=0;c<a.values.length;c++)l?(s+='<span class="numbervalueslast">',l=!1):s+='<span class="numbervalues">',s+=e("number")(a.values[c].value,0)+"</span>"}if(t.showdescription){var d=l?angular.element('<span class="numbervalueslast"></span>'):angular.element('<span class="numbervalues"></span>');a.description&&d.text(a.description),s+=d[0].outerHTML}s+="</div></div>"}}),a.append(s)}else if(t.changeditemrows[0]>=0&&t.changeditemrows[1]<0)l=t.changeditemrows[0],a[0].querySelector('.evtitemrow[index="'+l+'"]').classList.add("bg-light"),!0===t.items[l].children&&t.items[l].expanded<=0&&(a[0].querySelector(".evtitemrow[index='"+l+"'] .fa").classList="fa fa-caret-right"),!0===t.items[l].children&&t.items[l].expanded>0&&(a[0].querySelector(".evtitemrow[index='"+l+"'] .fa").classList="fa fa-caret-down"),!0===t.items[l].children&&t.items[l].expanded>0?a[0].querySelector('.evtitemrow[index="'+l+'"]').nextSibling.style.display="block":!0===t.items[l].children&&t.items[l].expanded<=0&&(a[0].querySelector('.evtitemrow[index="'+l+'"]').nextSibling.style.display="none");else if(t.changeditemrows[0]>=0&&t.changeditemrows[1]>0){l=t.changeditemrows[0];var d=0;c=t.changeditemrows[1]-t.changeditemrows[0];const r=Array.apply(null,a[0].querySelectorAll(".evtitemrow")).slice(t.changeditemrows[0]+1);angular.forEach(r,function(e){d=parseInt(e.getAttribute("index"))+c,e.setAttribute("index",""+d)}),a[0].querySelector(".evtitemrow[index='"+t.changeditemrows[0]+"'] .fa").classList="fa fa-caret-down",s='<div level="'+t.items[t.changeditemrows[0]+1].lvl+'">',angular.forEach(t.items.slice(t.changeditemrows[0]+1,t.changeditemrows[1]+1),function(a,r){if(l=t.changeditemrows[0]+r+1,!0===a.visible&&!a.hide){s+="<div index="+l+' class="d-flex flex-wrap evtitemrow',a.item===t.selecteditem&&(s+=" bg-light"),s+='"><div style="overflow:hidden; text-align: left; padding-left: '+13*a.lvl+'px">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');if(o.text(a.item),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">',a.values&&(s+='<span class="numbervalueslast">'+e("number")(a.values[2].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[1].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[0].value,0)+"</span>"),t.showdescription){var n=a.values?angular.element('<span class="numbervalues"></span>'):angular.element('<span class="numbervalueslast"></span>');a.description&&n.text(a.description),s+=n[0].outerHTML}s+="</div></div>"}}),s+="</div>",a.find(".evtitemrow[index='"+t.changeditemrows[0]+"']").after(s)}}()})}}}function locationstable(e){return{transclude:!1,link:function(t,a,s){a.on("click",".evtlocatrow",function(e){$(this).css("background-color",""),angular.element(document).find("#locationstable .evtlocatrow").removeClass("bg-light"),angular.element(e.target).closest(".evtlocatrow").addClass("bg-light");var a=parseInt(angular.element(e.target).closest(".evtlocatrow").attr("index"));t.$apply(function(){t.selectLocation(a)})}),a.on("mouseenter",".evtlocatrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","#f5f5f5")}),a.on("mouseleave",".evtlocatrow",function(){$(this).hasClass("bg-light")||$(this).css("background-color","")}),t.$watchGroup(["locations","locationstrigger"],function(s,r,o){!function(){var s="";if(-1===t.changedlocationrows[0]&&-1===t.changedlocationrows[1]){a.children().remove(),s='<div class="d-table w-100"><div style="float: left; overflow:hidden;">&nbsp;</div><div class="ms-auto text-right">';var r=!0;if(t.buckets)for(var o=0;o<t.buckets.length;o++)r?(s+='<span class="numbervalueslast"><strong><small>',r=!1):s+='<span class="numbervalues"><strong><small>',s+=t.buckets[o]+"</small></strong></span>";t.showdescription&&(s+=r?'<span class="numbervalueslast"></span>':'<span class="numbervalues"></span>'),s+="</div></div>";var n=0,i=0,l=0,c=0;angular.forEach(t.locations,function(a,r){if((i=a.lvl)>n?s+='<div level="'+i+'">':i<n&&(s+="</div>"),n=i,!0===a.visible&&!a.hide){s+="<div index="+r+' class="d-flex flex-wrap evtlocatrow',a.location===t.selectedlocation&&(s+=" bg-light"),s+='"><div style="overflow:hidden; padding-left: '+13*a.lvl+'px">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');o.text(a.location),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">';var l=!0;if(a.values){a.values.reverse();for(var c=0;c<a.values.length;c++)l?(s+='<span class="numbervalueslast">',l=!1):s+='<span class="numbervalues">',s+=e("number")(a.values[c].value,0)+"</span>"}if(t.showdescription){var d=l?angular.element('<span class="numbervalueslast"></span>'):angular.element('<span class="numbervalues"></span>');a.description&&d.text(a.description),s+=d[0].outerHTML}s+="</div></div>"}}),a.append(s)}else if(t.changedlocationrows[0]>=0&&t.changedlocationrows[1]<0)l=t.changedlocationrows[0],a[0].querySelector('.evtlocatrow[index="'+l+'"]').classList.add("bg-light"),!0===t.locations[l].children&&t.locations[l].expanded<=0&&(a[0].querySelector(".evtlocatrow[index='"+l+"'] .fa").classList="fa fa-caret-right"),!0===t.locations[l].children&&t.locations[l].expanded>0&&(a[0].querySelector(".evtlocatrow[index='"+l+"'] .fa").classList="fa fa-caret-down"),!0===t.locations[l].children&&t.locations[l].expanded>0?a[0].querySelector('.evtlocatrow[index="'+l+'"]').nextSibling.style.display="block":!0===t.locations[l].children&&t.locations[l].expanded<=0&&(a[0].querySelector('.evtlocatrow[index="'+l+'"]').nextSibling.style.display="none");else if(t.changedlocationrows[0]>=0&&t.changedlocationrows[1]>0){l=t.changedlocationrows[0];var d=0;c=t.changedlocationrows[1]-t.changedlocationrows[0];const r=Array.apply(null,a[0].querySelectorAll(".evtlocatrow")).slice(t.changedlocationrows[0]+1);angular.forEach(r,function(e){d=parseInt(e.getAttribute("index"))+c,e.setAttribute("index",""+d)}),a[0].querySelector(".evtlocatrow[index='"+t.changedlocationrows[0]+"'] .fa").classList="fa fa-caret-down",s='<div level="'+t.locations[t.changedlocationrows[0]+1].lvl+'">',angular.forEach(t.locations.slice(t.changedlocationrows[0]+1,t.changedlocationrows[1]+1),function(a,r){if(l=t.changedlocationrows[0]+r+1,!0===a.visible&&!a.hide){s+='<div index="'+l+'" class="d-flex flex-wrap evtlocatrow',a.location===t.selectedlocation&&(s+=" bg-light"),s+='"><div style="overflow:hidden; padding-left: '+13*a.lvl+'px">&nbsp;',!0===a.children&&a.expanded<=0&&(s+='<span class="fa fa-caret-right"></span>'),!0===a.children&&a.expanded>0&&(s+='<span class="fa fa-caret-down"></span>'),!1===a.children&&(s+="<span>&nbsp;</span>");var o=angular.element('<span style="white-space:nowrap"></span>');if(o.text(a.location),a.description&&o.attr("title",a.description),s+=o[0].outerHTML+'</div><div class="ms-auto text-right">',a.values&&(s+='<span class="numbervalueslast">'+e("number")(a.values[2].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[1].value,0)+'</span><span class="numbervalues">'+e("number")(a.values[0].value,0)+"</span>"),t.showdescription){var n=a.values?angular.element('<span class="numbervalues"></span>'):angular.element('<span class="numbervalueslast"></span>');a.description&&n.text(a.description),s+=n[0].outerHTML}s+="</div></div>"}}),s+="</div>",a.find(".evtlocatrow[index='"+t.changedlocationrows[0]+"']").after(s)}}()})}}}function displayForecastGrid(e,t,a){return{restrict:"EA",scope:{forecastdata:"=data",grid:"=grid",label:"@",onClick:"&",rows:"=rows",measures:"=measures"},templateUrl:"/static/forecast/forecastgrid.html",link:function(e,s,r){angular.element(document).find("#horizonbuckets").val();var o=a.getString("Demand outlier");parseInt(new Date(Date.parse(currentdate)).getYear()+1900);function n(t,a){var s=new Date(e.forecastdata.forecast[t].startdate),r=new Date(e.forecastdata.forecast[t].enddate),o=new Date(-31536e6*a+Math.round(s.getTime()+(r.getTime()-s.getTime())/2));for(var n in e.forecastdata.forecast){var i=new Date(e.forecastdata.forecast[n].startdate.substring(0,10)),l=new Date(e.forecastdata.forecast[n].enddate.substring(0,10));if(o>=i&&o<l)return n}}function i(){var a=angular.element(s),r=0,i=0,l=0,c=(e.grid.nthird,e.grid.nsecond,e.grid.nfirst,e.grid.currentbucket),d=admin_escape(e.forecastdata.attributes.item[0][1]),u=admin_escape(e.forecastdata.attributes.location[0][1]),m=admin_escape(e.forecastdata.attributes.customer[0][1]),f="",p=[];angular.forEach(e.rows,function(e){p.push("<tr>")}),angular.forEach(e.forecastdata.forecast,function(t,a){if(a>=c)for(var s in r=n(a,3),i=n(a,2),l=n(a,1),f+='<th class="text-center text-nowrap" style="background-color: #aaa" title="'+moment(t.startdate,"YYYY-MM-DD hh:mm:ss").format(dateformat)+" - "+moment(t.enddate,"YYYY-MM-DD hh:mm:ss").format(dateformat)+'">'+t.bucket+"</th>",e.rows){var g,v,h=e.measures[e.rows[s]],b=h.name.replace("3ago","").replace("2ago","").replace("1ago","");switch(h.name){case"orderstotal1ago":g=l>=0?e.forecastdata.forecast[l].orderstotal:null,v=l;break;case"orderstotalvalue1ago":g=l>=0?e.forecastdata.forecast[l].orderstotalvalue:null,v=l;break;case"orderstotal2ago":g=i>=0?e.forecastdata.forecast[i].orderstotal:null,v=i;break;case"orderstotalvalue2ago":g=i>=0?e.forecastdata.forecast[i].orderstotalvalue:null,v=i;break;case"orderstotal3ago":g=r>=0?e.forecastdata.forecast[r].orderstotal:null,v=r;break;case"orderstotalvalue3ago":g=r>=0?e.forecastdata.forecast[r].orderstotalvalue:null,v=r;break;case"ordersadjustment1ago":g=l>=0?e.forecastdata.forecast[l].ordersadjustment:null,v=l;break;case"ordersadjustmentvalue1ago":g=l>=0?e.forecastdata.forecast[l].ordersadjustmentvalue:null,v=l;break;case"ordersadjustment2ago":g=i>=0?e.forecastdata.forecast[i].ordersadjustment:null,v=i;break;case"ordersadjustmentvalue2ago":g=i>=0?e.forecastdata.forecast[i].ordersadjustmentvalue:null,v=i;break;case"ordersadjustment3ago":g=r>=0?e.forecastdata.forecast[r].ordersadjustment:null,v=r;break;case"ordersadjustmentvalue3ago":g=r>=0?e.forecastdata.forecast[r].ordersadjustmentvalue:null,v=r;break;default:g=t[e.rows[s]],v=a}if(void 0===v)p[s]+="<td></td>";else if("edit"==h.mode_future)p[s]+='<td><input type="number" class="smallpadding" data-measure="'+b+'" data-index="'+v+'" '+(null===g?"":' value="'+g+'" ')+'tabindex="'+s+'" data-ng-model="forecastdata.forecast['+v+"]."+b+'" data-ng-focus="$parent.focusEdit($event)"><br></td>';else{var w=e.rows[s].includes("backlog")&&null!==t[e.rows[s]]&&t[e.rows[s]]>0;switch(p[s]+='<td class="text-center text-nowrap">',w&&(p[s]+="<span class='red'>"),"currency"==h.formatter?p[s]+=e.grid.prefix+grid.formatNumber(g,2)+e.grid.suffix:p[s]+=grid.formatNumber(g),w&&(p[s]+="</span>"),h.name){case"ordersopen":case"ordersopenvalue":0!=t[e.rows[s]]&&(p[s]+='<a href="'+url_prefix+"/forecast/demand/?noautofilter&item__name__ico="+d+"&location__name__ico="+u+"&customer__name__ico="+m+"&due__gte="+t.startdate+"&due__lt="+t.enddate+'&status=open"><span class="ps-1 fa fa-caret-right" onclick="event.preventDefault();event.stopImmediatePropagation();window.location.href=$(event.target).parent().attr(\'href\')"></span></a>');break;case"orderstotal":case"orderstotalvalue":0!=t[e.rows[s]]&&(p[s]+='<a href="'+url_prefix+"/forecast/demand/?noautofilter&item__name__ico="+d+"&location__name__ico="+u+"&customer__name__ico="+m+"&due__gte="+t.startdate+"&due__lt="+t.enddate+'"><span class="ps-1 fa fa-caret-right" onclick="event.preventDefault();event.stopImmediatePropagation();window.location.href=$(event.target).parent().attr(\'href\')"></span></a>');break;case"orderstotal1ago":case"orderstotalvalue1ago":l>=0&&(1==e.forecastdata.forecast[l].outlier&&(p[s]+='<span class="fa fa-warning text-danger" data-bs-toggle="tooltip" data-bs-title="'+o+'" data-ng-mouseover="outlierTooltip($event)"></span>'),0!=e.forecastdata.forecast[l].orderstotal&&(p[s]+='<a href="'+url_prefix+"/forecast/demand/?noautofilter&item__name__ico="+d+"&location__name__ico="+u+"&customer__name__ico="+m+"&due__gte="+e.forecastdata.forecast[l].startdate+"&due__lt="+e.forecastdata.forecast[l].enddate+'"><span class="ps-1 fa fa-caret-right" onclick="event.preventDefault();event.stopImmediatePropagation();window.location.href=$(event.target).parent().attr(\'href\')"></span></a>'));break;case"orderstotal2ago":case"orderstotalvalue2ago":i>=0&&(1==e.forecastdata.forecast[i].outlier&&(p[s]+='<span class="fa fa-warning text-danger" data-bs-toggle="tooltip" data-bs-title="'+o+'" data-ng-mouseover="outlierTooltip($event)"></span>'),0!=e.forecastdata.forecast[i].orderstotal&&(p[s]+='<a href="'+url_prefix+"/forecast/demand/?noautofilter&item__name__ico="+d+"&location__name__ico="+u+"&customer__name__ico="+m+"&due__gte="+e.forecastdata.forecast[i].startdate+"&due__lt="+e.forecastdata.forecast[i].enddate+'"><span class="ps-1 fa fa-caret-right" onclick="event.preventDefault();event.stopImmediatePropagation();window.location.href=$(event.target).parent().attr(\'href\')"></span></a>'));break;case"orderstotal3ago":case"orderstotalvalue3ago":r>=0&&(1==e.forecastdata.forecast[r].outlier&&(p[s]+='<span class="fa fa-warning text-danger" data-bs-toggle="tooltip" data-bs-title="'+o+'" data-ng-mouseover="outlierTooltip($event)"></span>'),0!=e.forecastdata.forecast[r].orderstotal&&(p[s]+='<a href="'+url_prefix+"/forecast/demand/?noautofilter&item__name__ico="+d+"&location__name__ico="+u+"&customer__name__ico="+m+"&due__gte="+e.forecastdata.forecast[r].startdate+"&due__lt="+e.forecastdata.forecast[r].enddate+'"><span class="ps-1 fa fa-caret-right" onclick="event.preventDefault();event.stopImmediatePropagation();window.location.href=$(event.target).parent().attr(\'href\')"></span></a>'))}p[s]+="</td>"}}});var g='<tbody id="forecasttablebody">';for(var v of p)g+=v+"</tr>";g+="</tbody>",a.find("#row0").replaceWith('<tr id="row0">'+f+"</tr>"),a.find("#forecasttablebody").replaceWith(t(g)(e)),e.grid.setPristine=!1}e.$watch("forecastdata.attributes",function(t,a){"object"==typeof e.forecastdata&&(e.forecastdata.attributes.hasOwnProperty("currency")&&(e.prefix=e.grid.prefix,e.suffix=e.grid.suffix),i())},!0),e.$watch("grid.setPristine",function(e,t){!0===e&&i()})}}}function displayForecastGraph(e,t){return{restrict:"EA",scope:{data:"=",label:"@",onClick:"&",rows:"=rows"},link:function(a,s,r){e.onresize=function(){a.$apply()},a.$watch(function(){return angular.element(e)[0].innerWidth},function(){a.render(a.data)}),a.$watch("data",function(e){a.render(e)},!0),a.render=function(e){if(e){var s=0,r=130,o=30,n=50,i=angular.element(document).find("#forecastgraph").width()-n-r,l=angular.element(document).find("#forecastgraph").height()-s-o,c=0,d=function(e){var t,s;if(a.rows.includes("orderstotal3ago")||a.rows.includes("ordersadjustment3ago")||a.rows.includes("ordersadjustmentvalue3ago")||a.rows.includes("ordersadjustmentvalue3ago"))return e[0].bucket;if(a.rows.includes("orderstotal2ago")||a.rows.includes("ordersadjustment2ago")||a.rows.includes("ordersadjustmentvalue2ago")||a.rows.includes("ordersadjustmentvalue2ago"))t=2;else{if(!(a.rows.includes("orderstotal1ago")||a.rows.includes("ordersadjustment1ago")||a.rows.includes("ordersadjustmentvalue1ago")||a.rows.includes("ordersadjustmentvalue1ago")))return currentbucket;t=1}for(var r in e)if(e[r].bucket==currentbucket){s=e[r];break}var o=new Date(s.startdate),n=new Date(s.enddate),i=new Date(-31536e6*t+Math.round(o.getTime()+(n.getTime()-o.getTime())/2));for(var r in e){var l=new Date(e[r].startdate.substring(0,10)),c=new Date(e[r].enddate.substring(0,10));if(i>=l&&i<c)return e[r].bucket}}(e),u=[],m=0,f=0,p=!1,g=[];for(c in e)p||e[c].bucket!=d||(f-=parseInt(c),p=!0),p&&(u.push(e[c].bucket),m=Math.max(e[c].bucket.length,m),g.push(e[c]),e[c].currentbucket&&(f+=parseInt(c)));var v=d3.scale.ordinal().domain(u).rangeRoundBands([0,i],0),h=v.rangeBand(),b=d3.scale.linear().rangeRound([l,0]);angular.element(document).find(angular.element(document).find("#forecastgraph").get(0)).html("");var w=d3.select(angular.element(document).find("#forecastgraph").get(0)).append("svg").attr("class","graphcell").attr("width",i+n+r).attr("height",l+s+o).append("g").attr("transform","translate("+n+","+s+")"),x=0,_=0;for(c in c=0,p=!1,g){var y=g[c];y.orderstotal+y.ordersadjustment>x&&(x=y.orderstotal+y.ordersadjustment),y.forecasttotal>x&&(x=y.forecasttotal),y.orderstotal<_&&(_=y.orderstotal),y.forecasttotal<_&&(_=y.forecasttotal)}b.domain([_,x]);var k,C=b(0);w.selectAll("g").data(g).enter().append("g").attr("transform",function(e){return"translate("+v(e.bucket)+",0)"}).each(function(e,a){var s=d3.select(this);e.ordersopen>0&&(k=b(e.ordersopen),s.append("rect").attr("width",h).attr("height",C-k).attr("x",h/2).attr("y",k).style("fill","#2B95EC")),s.append("rect").attr("height",l).attr("width",h).attr("fill-opacity",0).on("mouseenter",function(e){a>=f?graph.showTooltip('<div style="text-align:center"><strong>'+e.bucket+'</strong></div><table style="margin: 5px;"><tr><td>'+t.getString("total orders")+'</td><td style="text-align:right">'+grid.formatNumber(e.orderstotal)+"</td></tr><tr><td>"+t.getString("open orders")+'</td><td style="text-align:right">'+grid.formatNumber(e.ordersopen)+"</td></tr><tr><td>"+t.getString("orders adjustment")+'</td><td style="text-align:right">'+(null===e.ordersadjustment?"":grid.formatNumber(e.ordersadjustment))+"</td></tr><tr><td>"+t.getString("forecast baseline")+'</td><td style="text-align:right">'+grid.formatNumber(e.forecastbaseline)+"</td></tr><tr><td>"+t.getString("forecast override")+'</td><td style="text-align:right">'+(e.hasOwnProperty("forecastoverride")&&null!==e.forecastoverride?grid.formatNumber(e.forecastoverride):"")+"</td></tr><tr><td>"+t.getString("forecast total")+'</td><td style="text-align:right">'+grid.formatNumber(e.forecasttotal)+"</td></tr><tr><td>"+t.getString("forecast net")+'</td><td style="text-align:right">'+grid.formatNumber(e.forecastnet)+"</td></tr><tr><td>"+t.getString("forecast consumed")+'</td><td style="text-align:right">'+grid.formatNumber(e.forecastconsumed)+"</td></tr></table>"):graph.showTooltip('<div style="text-align:center"><strong>'+e.bucket+'</strong></div><table style="margin: 5px;"><tr><td>'+t.getString("total orders")+'</td><td style="text-align:right">'+grid.formatNumber(e.orderstotal)+"</td></tr><tr><td>"+t.getString("open orders")+'</td><td style="text-align:right">'+grid.formatNumber(e.ordersopen)+"</td></tr><tr><td>"+t.getString("orders adjustment")+'</td><td style="text-align:right">'+(null===e.ordersadjustment?"":grid.formatNumber(e.ordersadjustment))+"</td></tr><tr><td>"+t.getString("past forecast")+'</td><td style="text-align:right">'+grid.formatNumber(e.forecastbaseline)+"</td></tr></table>")}).on("mouseleave",graph.hideTooltip).on("mousemove",graph.moveTooltip)});var $=d3.svg.line().x(function(e){return v(e.bucket)+h/2}).y(function(e){return b(Math.max(0,e.orderstotal+e.ordersadjustment))});w.append("svg:path").attr("class","graphline").attr("stroke","#8BBA00").attr("d",$(g)),$=d3.svg.line().x(function(e){return v(e.bucket)+h/2}).y(function(e,t){return b(t>=f?e.forecasttotal:0)}),w.append("svg:path").attr("class","graphline").attr("stroke","#FF0000").attr("d",$(g)),$=d3.svg.line().x(function(e){return v(e.bucket)+h/2}).y(function(e,t){return b(t<f?e.forecasttotal:0)}),w.append("svg:path").attr("class","graphline").attr("stroke","#FF7B00").attr("d",$(g));var q=d3.svg.axis().scale(b).orient("left").tickFormat(d3.format("s"));w.append("g").attr("class","y axis").call(q);var S=Math.ceil(g.length/i*m*10),D=[];for(c in g)c%S==0&&D.push(g[c].bucket);var P=d3.svg.axis().scale(v).tickValues(D).orient("bottom");w.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(P);var j=w.append("g"),L=[["open orders","#2B95EC",1],["total orders","#8BBA00",0],["forecast total","#FF0000",5],["past forecast","#FF7B00",6]],M=0;for(c in L)j.append("rect").attr("x",i+82).attr("width",18).attr("height",18).style("fill",L[c][1]).attr("transform","translate(0,"+(20*M+10)+")"),j.append("text").attr("x",i+76).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(L[c][0]).attr("transform","translate(0,"+(20*M+10)+")"),M+=1}}}}}function forecastController(e,t,a,s){e.urlprefix="/"+angular.element(document).find("#database").attr("name"),"/default"!==e.urlprefix&&"/undefined"!==e.urlprefix||(e.urlprefix="");var r=s.path().split("/");r=admin_unescape(r[r.indexOf("editor")+1]),e.outlierTooltip=function(e){$(e.target).tooltip("show")},e.preferences=preferences,e.measures=measures,e.measurelist=[],angular.forEach(measures,function(t,a){e.measurelist.push(t)}),e.rows=e.preferences.rows,e.rows?e.rows=e.rows.filter(e=>e in measures):(e.rows=[],angular.forEach(measures,function(t,a){!0!==t.initially_hidden&&"hidden"!==t.mode_future&&e.rows.push(a)})),e.selecteditem=r,e.selectedlocation="",e.selectedcustomer="",e.detaildata="",e.changes=!1,e.sequence=e.preferences.sequence,e.measure=e.preferences.measure,e.showdescription=e.preferences.showdescription||!1,e.measure||(e.measure="forecasttotal"),e.showtab=e.preferences.showtab,e.buckets=null,e.currentbucket=0,e.commenttype=null,e.initialmethod="",e.forms={},e.databaseerrormodal=!0,e.datarowheight=e.preferences.height,e.smallestbucket=angular.element(document).find("#horizonbucketsul li").first().text(),e.buckettype=angular.element(document).find("#horizonbuckets").val(),e.prefix="",e.suffix="",e.years0=0,e.years1=0,e.years2=0,e.years3=0,e.ncurrent=0,e.nfirst=0,e.nsecond=0,e.nthird=0,e.date="",e.newcomment="",e.itemstrigger=0,e.customerstrigger=0,e.locationstrigger=0,e.changeditemrows=[-1,-1],e.changedcustomerrows=[-1,-1],e.changedlocationrows=[-1,-1],e.setPristine=!1;var o=!0,n=0,i=e.urlprefix+"/forecast/detail/",l=[e.selecteditem,e.selectedlocation,e.selectedcustomer],c=l,d=l,u=l,m={},f={},p=parseInt(new Date(Date.parse(currentdate)).getYear()+1900),g={},v=!1;e.modalcallback=null,e.showSaveChange=function(){return e.modalcallback=a.defer(),e.databaseerrormodal=!1,showModal("popup2"),e.modalcallback.promise},e.$watch("detaildata",function(t,a){""!==e.detaildata&&(o?(o=!1,e.changes=!1):v?(e.changes=!1,angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#recalculate").removeClass("disabled").prop("disabled",!0)):(e.changes=!0,angular.element(document).find("#save").removeClass("btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#recalculate").prop("disabled",!1)),v=!1)},!0),e.$watch("changes",function(e,t){e?(angular.element(document).find("#save").removeClass("btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-danger").addClass("btn-danger").prop("disabled",!1)):(angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0))});var h=!1;function b(t,a){for(var s of(p=parseInt(new Date(Date.parse(currentdate)).getYear()+1900),angular.forEach(t.data.attributes.item,function(t){"Name"!==t[0]||(e.selecteditem,t[1])}),angular.forEach(t.data.attributes.location,function(t){"Name"!==t[0]||(e.selectedlocation,t[1])}),angular.forEach(t.data.attributes.customer,function(t){"Name"!==t[0]||(e.selectedcustomer,t[1])}),e.commenttype=null,e.detaildata=angular.copy(t.data),e.detaildata.forecast)){var r=s.startdate.split(/[ \-]/);s.startdate_date=new Date(r[0],r[1]-1,r[2]),r=s.enddate.split(/[ \-]/),s.enddate_date=new Date(r[0],r[1]-1,r[2])}if(e.detaildata.attributes.hasOwnProperty("currency"))var o=angular.fromJson(e.detaildata.attributes.currency);e.grid={},void 0!==o?(e.grid.prefix=void 0!==o[0]?o[0]:"",e.grid.suffix=void 0!==o[1]?o[1]:""):(e.grid.prefix="",e.grid.suffix=""),e.initialmethod=t.data.attributes.forecast.forecastmethod,m={},angular.forEach(bucketsperyear,function(t){t.year===p-3?(e.nthird=t.bucketcount,e.grid.nthird=e.nthird):t.year===p-2?(e.nsecond=t.bucketcount,e.grid.nsecond=e.nsecond):t.year===p-1?(e.nfirst=t.bucketcount,e.grid.nfirst=e.nfirst):t.year===p&&(e.ncurrent=t.bucketcount,e.grid.currentYear=p)});for(let t in e.detaildata.forecast)m[e.detaildata.forecast[t].bucket]=t,e.detaildata.forecast[t].bucket===currentbucket&&(e.detaildata.forecast[t].currentbucket=!0,e.currentbucket=t,e.grid.currentbucket=e.currentbucket);e.changes=!1,e.loading=!1,g=angular.copy(e.detaildata),v=!0,e.grid.setPristine=!0}function w(a){e.preferences.measure=e.measure,e.preferences.sequence=e.sequence,e.preferences.showtab=e.showtab,e.preferences.showdescription=e.showdescription,e.preferences.height=angular.element(document).find("#data-row").height(),e.preferences.rows=e.rows,t.post(e.urlprefix+"/settings/",angular.toJson({"freppledb.forecast.planning":e.preferences})).then(function(t){e.databaseerrormodal=!1,"function"==typeof a&&a(t)},function(t){440119!=t.status?(e.databaseerrormodal=!0,angular.element(document).find("#popup2 .modal-body").html('<div style="width: 100%; overflow: auto;">'+t.data+"</div>"),showModal("popup2")):location.reload()})}e.$watch("[sequence,measure]",function(){!1!==h?(e.selecteditem=r,e.selectedlocation="",e.selectedcustomer="",e.changeditemrows=[-1,-1],e.changedlocationrows=[-1,-1],e.changedcustrows=[-1,-1],e.itemstrigger+=1,e.locationstrigger+=1,e.customerstrigger+=1,e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,"",""]),e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,"",""]),e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,"",""])):h=!0},!0),e.refreshPanels=function(a,s,r){"items"==s&&-1==e.sequence.indexOf("I")||"locations"==s&&-1==e.sequence.indexOf("L")||"customers"==s&&-1==e.sequence.indexOf("C")||(a+="?measure="+admin_escape(e.measure),""!==r[0]&&"string"==typeof r[0]&&(a+="&item="+admin_escape(r[0])),""!==r[1]&&(a+="&location="+admin_escape(r[1])),""!==r[2]&&(a+="&customer="+admin_escape(r[2])),"items"===s&&r[0]&&(a+="&first=1"),t.get(a).then(function(t){if(0===t.data.length&&(e.databaseerrormodal=!0,angular.element(document).find("#popup2 .modal-body").html('<div style="width: 100%; overflow: auto;">No data found for specified '+s+"</div>"),showModal("popup2")),!e.buckets&&t.data[0].values){e.buckets=[];for(let a of t.data[0].values)e.buckets.push(a.bucketname);e.buckets.reverse()}if("items"===s){if(e.items=t.data,e.changeditemrows=[-1,-1],""!==e.selecteditem){for(let t of e.items)t.children&&t.lvl<=e.selecteditemlevel&&0===t.expanded&&(t.expanded=1);for(let t of e.items)if(t.item===e.selecteditem){t.description&&t.description.length>0?e.selecteditemdescription=" ("+t.description+")":e.selecteditemdescription="";break}return}e.selecteditem=e.items[0].item;for(let t of e.items)t.children&&0===t.lvl&&0===t.expanded&&(t.expanded=1)}else{if("locations"===s){if(e.locations=t.data,e.changedlocationrows=[-1,-1],""===e.selectedlocation){e.selectedlocation=e.locations[0].location;for(let t of e.locations)t.children&&0===t.lvl&&0===t.expanded&&(t.expanded=1)}else for(let t of e.locations)t.children&&t.lvl<=e.selectedlocationlevel&&0===t.expanded&&(t.expanded=1);for(let t of e.locations)if(t.location===e.selectedlocation){t.description&&t.description.length>0?e.selectedlocationdescription=" ("+t.description+")":e.selectedlocationdescription="";break}return}if("customers"===s){if(e.customers=t.data,e.changedcustomerrows=[-1,-1],""===e.selectedcustomer){e.selectedcustomer=e.customers[0].customer;for(let t of e.customers)t.children&&0===t.lvl&&0===t.expanded&&(t.expanded=1)}else for(let t of e.customers)t.children&&t.lvl<=e.selectedcustomerlevel&&0===t.expanded&&(t.expanded=1);for(const t of e.customers)if(t.customer===e.selectedcustomer){t.description&&t.description.length>0?e.selectedcustomerdescription=" ("+t.description+")":e.selectedcustomerdescription="";break}return void("items"===s?c=r:"locations"===s?d=r:"customers"===s&&(u=r))}}},function(t){401!=t.status?(e.databaseerrormodal=!0,angular.element(document).find("#popup2 .modal-body").html('<div style="width: 100%; overflow: auto;">'+t.data+"</div>"),showModal("popup2")):location.reload()}))},e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",d),e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",u),e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",c),e.getDetail=function(){var a=i;e.loading=!0,a+="?measure="+admin_escape(e.measure),a+="&item="+admin_escape(e.selecteditem),a+="&location="+admin_escape(e.selectedlocation),a+="&customer="+admin_escape(e.selectedcustomer),t.get(a).then(function(e){b(e)})},e.getDetail(),e.getBucket=function(t,a){if("day"===e.buckettype)return t-365*a;if("week"===e.buckettype){for(var s in e.detaildata.forecast)if(e.detaildata.forecast[s].year===p-a&&e.detaildata.forecast[s].weeknumber===e.detaildata.forecast[t].weeknumber)return s}else{if("month"===e.buckettype)return t-12*a;if("quarter"===e.buckettype)return t-4*a;if("year"===e.buckettype)return t-a}},e.refreshScreen=function(){l=[e.selecteditem,e.selectedlocation,e.selectedcustomer],e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",c),e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",d),e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",u),e.commenttype=null,e.newcomment="",e.getDetail()},e.checkbucket=function(t){return t>=e.currentbucket&&t<e.currentbucket+e.bucketsperyear},e.drillDown=function(a,s,r,o){var n=0,i=0;if(a+="?measure="+admin_escape(e.measure),""!==r[0]&&(a+="&item="+admin_escape(r[0])),""!==r[1]&&(a+="&location="+admin_escape(r[1])),""!==r[2]&&(a+="&customer="+admin_escape(r[2])),"items"!==s)if("locations"!==s)if("customers"!==s);else{if(!1===e.customers[o].children)return;if(0===e.customers[o].expanded)t.get(a).then(function(t){0!==t.data.length&&(e.customers.splice.apply(e.customers,[o+1,0].concat(t.data)),e.customers[o].expanded=t.data.length,e.customerstrigger+=1,e.changedcustomerrows=[o,o+t.data.length])});else{if(n=o+1,e.changedcustomerrows[0]=o,i=e.customers.length,void 0===e.customers[n])return;for(;e.customers[o].lvl!==e.customers[n].lvl&&(e.customers[n].lvl===e.customers[o].lvl+1&&(e.customers[n].visible=!e.customers[n].visible,e.customers[n].hide=!1),e.customers[n].lvl>e.customers[o].lvl+1&&(e.customers[n].hide=!e.customers[n].hide),!(++n>i-1)););e.changedcustomerrows[1]=-1*(n-o),e.customers[o].expanded=-e.customers[o].expanded,e.customerstrigger+=1}u=r}else{if(!1===e.locations[o].children)return;if(0===e.locations[o].expanded)t.get(a).then(function(t){0!==t.data.length&&(e.locations.splice.apply(e.locations,[o+1,0].concat(t.data)),e.locations[o].expanded=t.data.length,e.locationstrigger+=1,e.changedlocationrows=[o,o+t.data.length])});else{if(e.changedlocationrows[0]=o,n=o+1,i=e.locations.length,void 0===e.locations[n])return;for(;e.locations[o].lvl!==e.locations[n].lvl&&(e.locations[n].lvl===e.locations[o].lvl+1&&(e.locations[n].visible=!e.locations[n].visible,e.locations[n].hide=!1),e.locations[n].lvl>e.locations[o].lvl+1&&(e.locations[n].hide=!e.locations[n].hide),!(++n>i-1)););e.changedlocationrows[1]=-1*(n-o),e.locations[o].expanded=-e.locations[o].expanded,e.locationstrigger+=1}d=r}else{if(!1===e.items[o].children)return;if(0===e.items[o].expanded)t.get(a).then(function(t){0!==t.data.length&&(e.items.splice.apply(e.items,[o+1,0].concat(t.data)),e.items[o].expanded=t.data.length,e.itemstrigger+=1,e.changeditemrows=[o,o+t.data.length])});else{for(e.changeditemrows[0]=o,n=o+1,i=e.items.length;e.items[o].lvl!==e.items[n].lvl&&(e.items[n].lvl===e.items[o].lvl+1&&(e.items[n].visible=!e.items[n].visible,e.items[n].hide=!1),e.items[n].lvl>e.items[o].lvl+1&&(e.items[n].hide=!e.items[n].hide),!(++n>i-1)););e.changeditemrows[1]=-1*(n-o),e.items[o].expanded=-e.items[o].expanded,e.itemstrigger+=1}c=r}},e.selectItem=function(t){var a=e.items[t];e.changes?e.showSaveChange().then(function(s){"continue"===s?(e.changeItem.call(a,t),angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0)):"save"===s&&e.save(!1,function(){e.changeItem.call(a,t)}),hideModal("popup2")}):e.changeItem.call(a,t)},e.changeItem=function(t){n=e.sequence.indexOf("I"),e.selecteditem=this.item,this.description&&this.description.length>0?e.selecteditemdescription=" ("+this.description+")":e.selecteditemdescription="",e.selectedlocation.description&&e.selectedlocation.description.length>0?e.selectedlocationdescription=" ("+e.selectedlocation.description+")":e.selectedlocationdescription="",e.selectedcustomer.description&&e.selectedcustomer.description.length>0?e.selectedcustomerdescription=" ("+e.selectedcustomer.description+")":e.selectedcustomerdescription="",0===n?(e.selectedlocation="",e.selectedcustomer="",-1!==e.sequence.indexOf("L")&&e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,e.selectedlocation,e.selectedcustomer]),-1!==e.sequence.indexOf("C")&&e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):1===n&&(2===e.sequence.indexOf("L")?(e.selectedlocation="",e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):2===e.sequence.indexOf("C")&&(e.selectedcustomer="",e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,e.selectedlocation,e.selectedcustomer]))),this.children&&e.drillDown(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,e.selectedlocation,e.selectedcustomer],t),e.getDetail()},e.selectLocation=function(t){var a=e.locations[t];e.changes?e.showSaveChange().then(function(s){"continue"===s?(e.changeLocation.call(a,t),angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0)):"save"===s&&e.save(!1,function(){e.changeLocation.call(a,t)}),hideModal("popup2")}):e.changeLocation.call(a,t)},e.changeLocation=function(t){n=e.sequence.indexOf("L"),e.selectedlocation=this.location,this.description&&this.description.length>0?e.selectedlocationdescription=" ("+this.description+")":e.selectedlocationdescription="",e.selecteditem.description&&e.selecteditem.description.length>0?e.selecteditemdescription=" ("+e.selecteditem.description+")":e.selecteditemdescription="",e.selectedcustomer.description&&e.selectedcustomer.description.length>0?e.selectedcustomerdescription=" ("+e.selectedcustomer.description+")":e.selectedcustomerdescription="",0===n?(e.selecteditem=r,e.selectedcustomer="",-1!==e.sequence.indexOf("I")&&e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,e.selectedlocation,e.selectedcustomer]),-1!==e.sequence.indexOf("C")&&e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):1===n&&(2===e.sequence.indexOf("I")?(e.selecteditem=r,e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):2===e.sequence.indexOf("C")&&(e.selectedcustomer="",e.refreshPanels(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,e.selectedlocation,e.selectedcustomer]))),this.children&&e.drillDown(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,e.selectedlocation,e.selectedcustomer],t),e.getDetail()},e.selectCustomer=function(t){var a=e.customers[t];e.changes?e.showSaveChange().then(function(s){"continue"===s?(e.changeCustomer.call(a,t),angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0)):"save"===s&&e.save(!1,function(){e.changeCustomer.call(a,t)}),hideModal("popup2")}):e.changeCustomer.call(a,t)},e.changeCustomer=function(t){n=e.sequence.indexOf("C"),e.selectedcustomer=this.customer,this.description&&this.description.length>0?e.selectedcustomerdescription=" ("+this.description+")":e.selectedcustomerdescription="",e.selecteditem.description&&e.selecteditem.description.length>0?e.selecteditemdescription=" ("+e.selecteditem.description+")":e.selecteditemdescription="",e.selectedlocation.description&&e.selectedlocation.description.length>0?e.selectedlocationdescription=" ("+e.selectedlocation.description+")":e.selectedlocationdescription="",0===n?(e.selecteditem=r,e.selectedlocation="",-1!==e.sequence.indexOf("I")&&e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,e.selectedlocation,e.selectedcustomer]),-1!==e.sequence.indexOf("L")&&e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):1===n&&(2===e.sequence.indexOf("I")?(e.selecteditem=r,e.refreshPanels(e.urlprefix+"/forecast/itemtree/","items",[e.selecteditem,e.selectedlocation,e.selectedcustomer])):2===e.sequence.indexOf("L")&&(e.selectedlocation="",e.refreshPanels(e.urlprefix+"/forecast/locationtree/","locations",[e.selecteditem,e.selectedlocation,e.selectedcustomer]))),this.children&&e.drillDown(e.urlprefix+"/forecast/customertree/","customers",[e.selecteditem,e.selectedlocation,e.selectedcustomer],t),e.getDetail()},e.busy_saving=!1,e.postDetail=function(a,s){e.busy_saving=!0,t.post(service_url+"forecast/detail/?measure="+admin_escape(e.measure),angular.toJson(a),{headers:{Authorization:"Bearer "+service_token}}).then(function(t){e.databaseerrormodal=!1,s(t),e.busy_saving=!1},function(t){if(401!=t.status){if(e.databaseerrormodal=!0,hasOwnProperty(t.data,"errors")){var a="";for(var s of t.data.errors)a+=s+"<br>"}else a=t.data;angular.element(document).find("#popup2 .modal-body").html('<div style="width: 100%; overflow: auto;">'+a+"</div>"),showModal("popup2"),e.busy_saving=!1}else location.reload()})},e.savePreferences=w,e.undo=function(){angular.element(document).find("div.tooltip").tooltip("hide"),angular.element(document).find("#save").removeClass("btn-danger").prop("disabled",!0),angular.element(document).find("#undo").removeClass("btn-danger").prop("disabled",!0),e.commenttype=null,e.newcomment="",!0===e.changes&&(e.detaildata=angular.copy(g),v=!0),e.grid.setPristine=!0},e.save=function(t,a){if(!e.busy_saving){f={},admin_escape(e.measure),admin_escape(e.selecteditem),admin_escape(e.selectedlocation),admin_escape(e.selectedcustomer),f.recalculate=t,f.units=e.measure,f.item=e.selecteditem,f.location=e.selectedlocation,f.customer=e.selectedcustomer,f.horizonbuckets=angular.element(document).find("#horizonbuckets").val(),""!==e.newcomment&&(f.comment=e.newcomment,f.commenttype=e.commenttype),f.forecastmethod=e.detaildata.attributes.forecast.forecastmethod,f.horizon=angular.element(document).find("#horizonbuckets").val(),f.buckets=[];for(let t of angular.element(document).find("#fforecasttable .ng-dirty")){var s=t.value;""==s&&(s=e.measures[t.getAttribute("data-measure")].defaultvalue),f.buckets.push({bucket:e.detaildata.forecast[parseInt(t.getAttribute("data-index"))].bucket,[t.getAttribute("data-measure")]:s})}e.postDetail(f,function(s){t?void 0!==s.data&&b(s):("function"==typeof a&&a(),e.getDetail())})}},e.showCustomizeGrid=function(){var t=angular.element("#popup");t.html('<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">'+gettext("Customize")+'</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="row"><div class="col-6"><div class="card"><div class="card-header">'+gettext("Available Cross")+'</div><div class="card-body"><ul class="list-group" id="DroppointCrosses" style="height: 160px; overflow-y: scroll;"></ul></div></div></div><div class="col-6"><div class="card"><div class="card-header">'+gettext("Selected Cross")+'</div><div class="card-body"><ul class="list-group" id="Crosses" style="height: 160px; overflow-y: scroll;"></ul></div></div></div></div><div class="row mt-3"><div class="col-12"><input class="form-check-input" type="checkbox" id="showdescription"><label for="showdescription">&nbsp;&nbsp;'+gettext("Show descriptions")+'</label></div></div></div><div class="modal-footer justify-content-between"><input type="submit" id="cancelCustbutton" role="button" class="btn btn-gray" data-bs-dismiss="modal" value="'+gettext("Cancel")+'"><input type="submit" id="resetCustbutton" role="button" class="btn btn-primary" value="'+gettext("Reset")+'"><input type="submit" id="okCustbutton" role="button" class="btn btn-primary" value="'+gettext("OK")+'"></div></div></div>');var a=t.find("#Crosses"),s=t.find("#DroppointCrosses"),r=Object.values(e.measures);for(var o in e.rows){var n=$('<li class="list-group-item" style="cursor: move"></li>').text(e.measures[e.rows[o]].label).attr("data-value",e.rows[o]);r=r.filter(t=>t.name!=e.rows[o]),a.append(n)}for(var o of(r.sort((e,t)=>e.label.localeCompare(t.label)),r))n=$('<li class="list-group-item" style="cursor: move"></li>').text(o.label).attr("data-value",o.name),s.append(n);Sortable.create(a[0],{group:{name:"Crosses",put:["DroppointCrosses"]},animation:100}),Sortable.create(s[0],{group:{name:"DroppointCrosses",put:["Crosses"]},animation:100}),t.modal("show"),e.showdescription&&t.find("#showdescription").prop("checked",!0),t.find("#showdescription").on("change",function(){e.showdescription=t.find("#showdescription").is(":checked")}),t.find("#resetCustbutton").on("click",function(){e.rows=[],angular.forEach(measures,function(t,a){!0===t.initially_hidden||"hidden"===t.mode_future&&"hidden"===t.mode_past||e.rows.push(a)}),w(function(){window.location.href=window.location.href})}),t.find("#okCustbutton").on("click",function(){e.rows=[],$("#Crosses li").each(function(t,a){e.rows.push($(a).attr("data-value"))}),w(function(){window.location.href=window.location.href})})},e.edit_measure="forecastoverride",e.edit_startdate=new Date,e.edit_enddate=new Date,e.edit_mode=0,e.edit_set="",e.edit_inc_perc=null,e.edit_inc=null,e.edit_comment="",e.applyEdit=function(){if(!angular.element(document).find("#applyedit").hasClass("disabled")){angular.element(document).find("#forecasttablebody input.edit-cell").removeClass("edit-cell").addClass("ng-dirty"),e.edit_set=parseFloat(e.edit_set),e.edit_inc_perc=parseFloat(e.edit_inc_perc);var t=1+e.edit_inc_perc/100,a=e.measures[e.edit_measure];for(var s in e.edit_inc=parseFloat(e.edit_inc),e.detaildata.forecast)if(e.detaildata.forecast[s].startdate_date<e.edit_enddate&&e.detaildata.forecast[s].enddate_date>e.edit_startdate&&("forecastoverride"==e.edit_measure?(0==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]=e.edit_set:1==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]=e.detaildata.forecast[s].forecasttotal+e.edit_inc:2==e.edit_mode&&(e.detaildata.forecast[s][e.edit_measure]=e.detaildata.forecast[s].forecasttotal*t),e.detaildata.forecast[s].forecasttotal=-1!=e.detaildata.forecast[s].forecastoverride&&null!=e.detaildata.forecast[s].forecastoverride?e.detaildata.forecast[s].forecastoverride:e.detaildata.forecast[s].forecastbaseline):a.discrete?0==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]=Math.round(e.edit_set):1==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]=Math.round(e.detaildata.forecast[s][e.edit_measure]+e.edit_inc):2==e.edit_mode&&(e.detaildata.forecast[s][e.edit_measure]=Math.round(e.detaildata.forecast[s][e.edit_measure]*t)):0==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]=e.edit_set:1==e.edit_mode?e.detaildata.forecast[s][e.edit_measure]+=e.edit_inc:2==e.edit_mode&&(e.detaildata.forecast[s][e.edit_measure]*=t)),e.detaildata.forecast[s].startdate_date>e.edit_enddate)break}},e.changeEdit=function(){var t=""==e.edit_measure||0==e.edit_mode&&(""===e.edit_set||null===e.edit_set)||1==e.edit_mode&&!e.edit_inc||2==e.edit_mode&&!e.edit_inc_perc;for(var a in t?angular.element(document).find("#applyedit").addClass("disabled"):angular.element(document).find("#applyedit").removeClass("disabled"),angular.element(document).find("#forecasttablebody input.edit-cell").removeClass("edit-cell"),e.detaildata.forecast)if(e.detaildata.forecast[a].startdate_date<e.edit_enddate&&e.detaildata.forecast[a].enddate_date>e.edit_startdate&&angular.element(document).find('#forecasttablebody input[data-index="'+a+'"][data-measure="'+e.edit_measure+'"]').addClass("edit-cell"),e.detaildata.forecast[a].startdate_date>=e.edit_enddate)break},e.focusEdit=function(t){var a=t.target;e.edit_measure=a.getAttribute("data-measure");var s=e.detaildata.forecast[parseInt(a.getAttribute("data-index"))];e.edit_startdate=s.startdate_date,e.edit_enddate=s.enddate_date,e.changeEdit()},e.savefavorite=function(){"favorites"in e.preferences||(e.preferences.favorites={});var t=angular.element(document).find("#favoritename").val();e.preferences.favorites[t]={measure:e.measure,sequence:e.sequence,rows:e.rows},w(),favorite.check()},e.removefavorite=function(t,a){delete e.preferences.favorites[t],w(),a.stopPropagation()},e.openfavorite=function(t,a){e.measure=e.preferences.favorites[t].measure,e.sequence=e.preferences.favorites[t].sequence,e.rows=e.preferences.favorites[t].rows,e.grid.setPristine=!0}}forecastapp.config(["$httpProvider",function(e){e.defaults.xsrfCookieName="csrftoken",e.defaults.xsrfHeaderName="X-CSRFToken",e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),forecastapp.run(["gettextCatalog",function(e){e.setCurrentLanguage(language)}]),forecastapp.filter("urlEncode",[function(){return admin_escape}]),forecastapp.directive("customerstable",customerstable),customerstable.$inject=["$filter"],forecastapp.directive("itemstable",itemstable),itemstable.$inject=["$filter"],forecastapp.directive("locationstable",locationstable),locationstable.$inject=["$filter"],forecastapp.directive("displayForecastGrid",displayForecastGrid),displayForecastGrid.$inject=["$window","$compile","gettextCatalog"],forecastapp.directive("displayForecastGraph",displayForecastGraph),displayForecastGraph.$inject=["$window","gettextCatalog"],forecastapp.controller("forecastController",forecastController),forecastController.$inject=["$scope","$http","$q","$location"];
//# sourceMappingURL=frepple-forecast.min.js.map